# 求人照合RPAツール（rirekisho特化版）

田中形式履歴書に特化した、**安全性を最優先**に行うRPAツールです。

## 🎯 **プロジェクトの目的**

- PDFから抽出された求人情報をHERPサイトの求人と自動照合
- **間違った求人への応募を防ぐ**ため、厳格な安全性チェックを実装
- 曖昧なマッチングは全て拒否し、確実に一致するもののみ処理
- rirekisho形式PDFファイルから履歴書情報を自動抽出
- RAコメントから求人名と追加必須項目を解析

## 🏗️ **システム構成**

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   PDFファイル   │ -> │  PDF情報抽出    │ -> │  求人名抽出処理  │ -> │ HERPサイト照合  │
│  (履歴書データ) │    │  (氏名・年齢等)  │    │  (RAコメント解析) │    │ (厳格マッチング) │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
                                                                              │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   JSONファイル   │ -> │  求人名抽出処理  │ -> │ HERPサイト照合  │ -> │ 推薦ボタンクリック │
│  (PDF由来データ) │    │  (安全性チェック) │    │ (厳格マッチング) │    │  (自動推薦実行)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 📋 **対応する入力形式**

### **1. PDFファイル（rirekisho形式履歴書）**
- rirekisho形式履歴書PDFから基本情報を自動抽出
- 氏名、年齢、電話番号、メールアドレス
- 現所属、最終学歴、推薦時コメント、職務要約

### **2. 従来形式（シンプル）**
```json
{
  "name": "インサイドセールス"
}
```

### **3. 新形式（複雑）**
```json
{
  "calib": {
    "record": {
      "ra_memo_raw": "W送付【マネジャー】インサイドセールス部署※現年収:600万円、希望年収:650万円"
    }
  }
}
```

## 🔍 **PDF処理機能**

### **抽出される情報**
- **基本情報**: 氏名、フリガナ、年齢、電話番号、メールアドレス
- **詳細情報**: 推薦時コメント、職務要約
- **学歴・職歴**: 現所属会社、最終学歴、詳細な経歴データ

### **抽出パターン**
```javascript
// 氏名抽出
const namePatterns = [
    /([一-龯]{1,4})[\s　]+([一-龯]{1,4})/,  // 田中　健太
    /^([一-龯]{2})([一-龯]{2})$/,          // 田中健太（4文字）
    /^([一-龯]{1})([一-龯]{2})$/           // 田中健太（3文字）
];

// 年齢抽出
const agePatterns = [
    /満(\d{1,2})歳/,           // 満25歳
    /\(満(\d{1,2})歳\)/,      // (満25歳)
    /（満(\d{1,2})歳）/,      // （満25歳）
    /(\d{1,2})歳\s*男/,       // 25歳 男
    /(\d{1,2})歳\s*女/        // 25歳 女
];

// 電話番号抽出
const phonePatterns = [
    /電話[：:\s]*(\d{2,4}[-\s]?\d{2,4}[-\s]?\d{4})/,
    /TEL[：:\s]*(\d{2,4}[-\s]?\d{2,4}[-\s]?\d{4})/,
    /(0\d{1,3}[-\s]?\d{2,4}[-\s]?\d{4})/,
    /(0\d{9,10})/
];
```

### **現所属・最終学歴の抽出**
```javascript
// 現所属会社名抽出
const companyPatterns = [
    /([^\s（\n]*(?:株式会社|有限会社|合同会社|合資会社|合名会社|一般社団法人|一般財団法人|公益社団法人|公益財団法人))\s*(?:入社|転職)/,
    /([^\s（\n]*(?:会社|法人|グループ|ホールディングス|コーポレーション))\s*(?:入社|転職)/,
    /([^\s（\n]+)\s*(?:入社|転職)/
];

// 最終学歴抽出
const educationPatterns = [
    /^([^\s]+(?:大学|短期大学|大学院|高等学校|高校|専門学校|専修学校|学院)(?:\s*[^\s]*学部)?(?:\s*[^\s]*学科)?(?:\s*[^\s]*専攻)?)\s*卒業/,
    /([^\s]+(?:大学|短期大学|大学院|高等学校|高校|専門学校|専修学校|学院)(?:\s*[^\s]*学部)?(?:\s*[^\s]*学科)?(?:\s*[^\s]*専攻)?)\s*卒業/
];
```

## 🔍 **RAコメント処理機能**

### **基本構造**
```
W送付[求人名]※[追加情報]
```

### **求人名抽出ロジック**
```javascript
// パターンマッチング
const wSendPattern = /W送付\s*(.+)/;
const wSendMatch = raMemoRaw.match(wSendPattern);

if (wSendMatch && wSendMatch[1]) {
    let afterWSend = wSendMatch[1].trim();
    let jobName;
    
    // ※がある場合は、そこで区切る
    if (afterWSend.includes('※')) {
        jobName = afterWSend.split('※')[0].trim();
    } else {
        // ※がない場合は、W送付の後全体を求人名とする
        jobName = afterWSend;
    }
}
```

### **追加必須項目の抽出パターン**

#### 年収関連
```javascript
const salaryRules = {
    currentSalary: {
        patterns: [/現年収[：:\s]*(\d+|０)万円?/g, /現在年収[：:\s]*(\d+|０)万円?/g],
        fieldNames: ['現在の年収', '年収（現在）', '現年収'],
        specialCases: { '０': '退職ケース', '0': '退職ケース' }
    },
    desiredSalary: {
        patterns: [/希望年収[：:\s]*(\d+)万円?/g],
        fieldNames: ['希望年収', '年収（希望）'],
        contextCheck: true
    },
    minimumSalary: {
        patterns: [/最低[希望]*年収[：:\s]*(\d+)万円?/g],
        fieldNames: ['最低希望年収', '年収（最低）']
    }
};
```

#### その他の条件
```javascript
const otherRules = {
    salaryNote: {
        patterns: [/希望年収.*?[【（\[].*?(仮|面談|確認).*?[】）\]]/g],
        fieldNames: ['その他希望条件', 'その他の希望条件', '備考']
    },
    currentCompany: {
        patterns: [/現職[はわ：:\s]*(.+?)[株式会社|会社|Corporation|Corp]/g],
        fieldNames: ['現所属', '現在の所属', '勤務先']
    }
};
```

### **テストケース例**

#### 全要素複合パターン
```
W送付プロジェクトマネージャー※現職はソニー株式会社、現年収:750万円、希望年収:850万円【希望年収は仮のため面談で確認】、最低希望年収:800万円
```
**抽出される必須項目**:
- 現在の年収
- 希望年収
- 最低希望年収
- その他希望条件（補足文言のため）
- 現所属

#### 退職ケース
```
W送付プロジェクトマネージャー※現年収:０万円（退職のため）、希望年収:700万円
```
**抽出される必須項目**:
- 現在の年収（退職ケースとして検出）
- 希望年収

## 🎯 **マッチングロジック（厳格4段階）**

### **Level 1: 完全一致（信頼度100%）**
```
JSON: "インサイドセールス"
HERP: "インサイドセールス"
→ ✅ 完全一致（処理続行）
```

### **Level 2: 正規化後完全一致（信頼度95%）**
```
JSON: "インサイド セールス"  (スペースあり)
HERP: "インサイドセールス"   (スペースなし)
→ 正規化: "インサイドセールス" = "インサイドセールス"
→ ✅ 正規化後一致（処理続行）
```

### **Level 3: 装飾除去後完全一致（信頼度90%）**
```
JSON: "【正社員】★プロジェクトマネージャー★"
HERP: "プロジェクトマネージャー"
→ 装飾除去: "プロジェクトマネージャー" = "プロジェクトマネージャー"
→ ✅ 装飾除去後一致（処理続行）
```

### **Level 4: 部分一致（信頼度85% → 0%拒否）**
```
JSON: "【マネジャー候補】インサイドセールス部署"
HERP: "インサイドセールス"
→ 部分一致を検出するが...
→ ❌ 信頼度85% < 90%（安全性のため拒否）
```

## 🚨 **安全性チェック（拒否条件）**

### **1. 信頼度不足**
```
信頼度90%未満 → 即座に拒否
理由: 人の人生に関わるため、不確実なマッチングは許可しない
```

### **2. 複数マッチ検出**
```
JSON: "インサイドセールス"
HERP: ["インサイドセールス", "インサイドセールス２"]
→ ❌ 複数の求人にマッチ（どちらが正しいか判断不可）
→ 即座に拒否
```

### **3. 異レベル複数マッチ**
```
完全一致: 1件 + 正規化後一致: 1件 = 計2件
→ ❌ 複数レベルでマッチ（混乱を避けるため拒否）
```

### **4. 部分一致（危険）**
```
JSON: "インサイドセールスマネジャー"
HERP: "インサイドセールス"
→ ❌ 部分一致（全く違う職種の可能性）
```

## ✅ **処理を通す条件**

### **絶対安全な条件のみ**
1. **単一の求人**にのみマッチ
2. **信頼度90%以上**
3. **完全一致系**（完全一致・正規化後一致・装飾除去後一致）
4. **抽出処理が正常**に完了
5. **対応するボタンが正確に特定**できる

### **具体例**
```
✅ "プロジェクトマネージャー" → "プロジェクトマネージャー" (100%) → ボタンクリック成功
✅ "インサイド セールス" → "インサイドセールス" (95%) → ボタンクリック成功
✅ "【正社員】エンジニア" → "エンジニア" (90%) → ボタンクリック成功
```

## 🎯 **自動推薦ボタンクリック機能**

### **機能概要**
マッチングが成功した場合、対応する「この職種に推薦する」ボタンを自動でクリックします。

### **ボタン特定ロジック**
1. **全ボタン検索**: ページ内の全ての「この職種に推薦する」ボタンを検出
2. **求人名対応**: 各ボタンから上位要素を辿って対応する求人名を特定
3. **完全一致**: マッチした求人名と完全一致するボタンを検索
4. **正規化一致**: 完全一致しない場合、正規化後の一致を確認
5. **安全クリック**: 対応するボタンのみを正確にクリック

### **検索方法（3段階）**
```javascript
// 方法1: CSSクラスによる検索
.agent-requisitions-table-list__cell.--name

// 方法2: テーブル構造による検索  
td:first-child > a

// 方法3: 行構造による検索
tr > td:first-child
```

### **安全性確保**
- **完全一致優先**: 求人名が完全に一致するボタンのみクリック
- **複数検出時拒否**: 複数のボタンが候補になった場合は処理停止
- **詳細ログ**: 全てのボタン-求人ペアを記録
- **エラーハンドリング**: クリック失敗時は詳細な情報を提供

### **クリック結果の表示**
- 🎯 **成功**: 緑色で「推薦ボタンクリック成功」を表示
- ❌ **失敗**: 赤色で失敗理由と対処法を表示
- 📊 **詳細**: 検出されたボタン数と対応関係を表示

## 🔧 **使用方法**

### **1. サーバー起動**
```bash
npm install
npm start
```

### **2. ブラウザアクセス**
```
http://localhost:3000
```

### **3. ファイルアップロード**
- **PDFファイル**: 履歴書PDFをドラッグ&ドロップ
- **JSONファイル**: PDF由来データをドラッグ&ドロップ
- または「ファイルを選択」ボタンから選択

### **4. 実行と結果確認**
- 「実行」ボタンをクリック
- 抽出過程と信頼度を確認
- マッチング結果を確認

## 📊 **UI表示内容**

### **PDF抽出情報**
- 抽出された基本情報（氏名、年齢、電話、メール）
- 現所属、最終学歴
- 推薦時コメント、職務要約
- 抽出信頼度

### **RAコメント解析**
- 抽出された求人名
- 検出された追加必須項目
- 年収情報の解析結果
- 警告メッセージ（あれば）

### **マッチング結果**
- マッチタイプ（完全一致・正規化後一致など）
- 信頼度バー（視覚的表示）
- マッチした求人名
- 拒否理由（拒否の場合）

### **詳細情報**
- 正規化後の文字列
- 装飾除去後の文字列
- 全求人のチェック結果
- 複数マッチの警告（該当時）

## 🧪 **テストケース**

### **PDF処理テストケース**
- 各種履歴書フォーマットに対応
- ページ跨ぎデータの処理
- ノイズ除去の検証
- セクション判定の精度確認

### **RAコメントテストケース**
- `test_ra_all_elements.json`: 全要素複合パターン
- `test_ra_salary_note.json`: 希望年収補足文言
- `test_ra_retirement_case.json`: 退職ケース
- `test_ra_current_company.json`: 現所属情報
- `test_ra_no_note.json`: 米印なしパターン

### **正常系**
- `input 3.json`: 基本的な新形式テスト
- `test_complex_1.json`: スペース過多パターン
- `test_strict_2.json`: 装飾除去後一致

### **拒否系（安全性確認）**
- `test_strict_1.json`: 危険な部分一致
- `test_multiple_match.json`: 複数マッチ検出
- `test_complex_3.json`: 求人名が短すぎる
- `test_complex_4.json`: 求人名が長すぎる

### **エラー系**
- `test_complex_5.json`: パターン不一致
- `test_complex_8.json`: フィールド欠損

## 🛡️ **安全性の設計思想**

### **保守的アプローチ**
> 「間違いの可能性が1%でもあれば拒否する」

### **人の人生重視**
> 「間違った求人への応募は人生を左右する」

### **透明性の確保**
> 「全ての判断過程をログに記録し、検証可能にする」

### **フェイルセーフ**
> 「システムに問題があれば安全に停止する」

## ⚠️ **運用上の注意点**

### **複数マッチが発生しやすいケース**
- 企業名が求人名に含まれる場合
- 類似求人が複数存在する場合
- 求人名に数字や記号が含まれる場合

### **手動確認が必要なケース**
- 複数マッチが検出された場合
- 部分一致のみの場合
- 信頼度90%未満の場合

### **システムの限界**
- 完全に同じ文字列でないと高信頼度にならない
- 表記ゆれや略語には対応しない
- 人間の最終確認が必要

## 🔄 **今後の改善予定**

### **Phase 1: 現在**
- 完全一致系のみ処理
- 複数マッチは即座に拒否
- 部分一致は全て拒否
- PDF処理とRAコメント処理の統合

### **Phase 2: 検討中**
- 許可リスト方式の導入
- より精密な文字差分解析
- 管理者による安全パターンの登録

### **Phase 3: 将来**
- 機械学習による類似度判定
- 企業固有の表記ルール学習
- より高度な自然言語処理

## 📞 **サポート**

システムに関する質問や問題が発生した場合：
1. まず`TEST_CASES_README.md`でテストケースを確認
2. ログファイルで詳細な処理過程を確認
3. 不明な点があれば開発チームに相談

## 📚 **関連ドキュメント**

- `PDF_ANALYSIS_DOCUMENTATION.md`: PDF処理とRAコメント処理の詳細技術仕様
- `TEST_CASES_README.md`: テストケースの詳細説明
- `package.json`: 依存関係とスクリプト

---

**重要**: このシステムは人の人生に関わる重要な判断を行います。安全性を最優先に設計されていますが、最終的な判断は必ず人間が行ってください。
