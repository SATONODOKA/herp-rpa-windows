  # PDF読み取り機能の詳細仕様

  ## 📋 概要
  現在のシステムで実装されているPDF読み取り機能の詳細な仕様と制限事項

  ---

  ## ✅ 読み取れる項目

  ### 1. 基本情報

  #### 氏名
  - **抽出方法**: 3段階のパターンマッチング
  - **パターン1**: 「氏名」ラベルの後（同じ行または次の行）
  - **パターン2**: 「フリガナ」ラベルの近く
  - **パターン3**: 一般的な日本語名パターン
  - **対応形式**:
    - `田中　健太` (全角スペース)
    - `田中健太` (スペースなし、4文字)
    - `田中健太` (スペースなし、3文字)
  - **信頼度**: 60-100% (氏名60% + 長さ20% + スペース10% + フリガナ10%)

  #### フリガナ
  - **抽出方法**: カタカナ・ひらがなパターンマッチング
  - **対応形式**:
    - カタカナ: `タナカケンタ`
    - ひらがな: `たなかけんた`
  - **処理**: カタカナをひらがなに自動変換
  - **信頼度**: 90-95%

  #### 年齢
  - **抽出パターン**:
    - `満25歳`
    - `(満25歳)`
    - `（満25歳）`
    - `満 25 歳`
    - `25歳 男`
    - `25歳 女`
  - **妥当性チェック**: 15-80歳の範囲
  - **信頼度**: 95%

  #### 電話番号
  - **抽出パターン**:
    - `電話 080-1234-5678`
    - `TEL: 080-1234-5678`
    - `080-1234-5678`
    - `08012345678`
  - **妥当性チェック**: 0で始まる10-11桁
  - **フォーマット**: 自動でハイフン区切りに変換
  - **信頼度**: 90%

  #### メールアドレス
  - **抽出パターン**:
    - 標準的なメールアドレス
    - ドメイン部分が短い場合
  - **信頼度**: 95%

  ### 2. 詳細情報

  #### 推薦時コメント
  - **抽出方法**: 「推薦理由」セクションから「面談所感」まで
  - **終了条件**: 面談所感、転職理由、添付資料、キャリアサポート部
  - **処理**: 空行も含めて改行情報を保持
  - **信頼度**: 90%

  #### 職務要約
  - **抽出方法**: 「職務要約」セクションから次のセクションまで
  - **終了条件**: 活かせる経験、スキル、資格、学歴、知識、技術
  - **処理**: 10文字以下の行は除外
  - **信頼度**: 85%

  ### 3. 学歴・職歴情報

  #### 学歴エントリ
  - **抽出方法**: 年月日パターンマッチング
  - **対応形式**:
    - `2015年3月`
    - `2015/3`
    - `2015-3`
    - `20153` (年月連続)
  - **セクション判定**: 「学歴」ラベルの検出
  - **信頼度**: 90%

  #### 職歴エントリ
  - **抽出方法**: 年月日パターンマッチング
  - **対応形式**: 学歴と同様
  - **セクション判定**: 「職歴」ラベルの検出
  - **信頼度**: 90%

  #### 現所属会社
  - **抽出方法**: 最新の職歴から会社名を抽出
  - **抽出パターン**:
    - `株式会社○○ 入社`
    - `有限会社○○ 転職`
    - `○○会社 入社`
  - **対象法人**: 株式会社、有限会社、合同会社、合資会社、合名会社、一般社団法人、一般財団法人、公益社団法人、公益財団法人
  - **信頼度**: 90%

  #### 最終学歴
  - **抽出方法**: 最新の学歴から卒業情報を抽出
  - **抽出パターン**:
    - `○○大学 卒業`
    - `○○大学 ○○学部 卒業`
    - `○○大学 ○○学部 ○○学科 卒業`
  - **対象学校**: 大学、短期大学、大学院、高等学校、高校、専門学校、専修学校、学院
  - **信頼度**: 90%

  ---

  ## ❌ 読み取れない項目

  ### 1. 文字化け問題
  - **G文字問題**: スペースの代わりにG文字が入る
  - **文字化け**: エンコーディングの問題
  - **特殊文字**: 制御文字や不要な文字

  ### 2. 表形式データ
  - **複雑な表**: セル結合された表
  - **画像内テキスト**: 画像として埋め込まれたテキスト
  - **PDFフォーム**: 入力フィールドの値

  ### 3. 特定の形式
  - **手書き文字**: 手書きで書かれた情報
  - **スキャン画像**: OCRが必要な画像
  - **暗号化PDF**: パスワード保護されたPDF

  ### 4. ノイズコンテンツ
  - **求人情報**: 求人関連の情報
  - **ファイルパス**: システム関連の情報
  - **日時情報**: システム生成の日時
  - **求人ID**: 求人番号など

  ---

  ## 🔧 処理ロジック

  ### 1. テキスト抽出
  ```javascript
  // pdf-parseを使用
  const dataBuffer = fs.readFileSync(pdfPath);
  const data = await pdfParse(dataBuffer);
  ```

  ### 2. テキスト前処理
  ```javascript
  // 行分割とクリーンアップ
  const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
  ```

  ### 3. パターンマッチング
  ```javascript
  // 正規表現によるパターンマッチング
  const patterns = [
      /([一-龯]{1,4})[\s　]+([一-龯]{1,4})/,  // 氏名パターン
      /満(\d{1,2})歳/,                        // 年齢パターン
      /電話[：:\s]*(\d{2,4}[-\s]?\d{2,4}[-\s]?\d{4})/,  // 電話番号パターン
  ];
  ```

  ### 4. セクション判定
  ```javascript
  // 学歴セクションの判定
  isEducationSectionStart(line) {
      return (line.includes('学歴') && !line.includes('職歴')) ||
            line === '学歴' ||
            (line.includes('学歴・職歴') && line.indexOf('学歴') < line.indexOf('職歴'));
  }
  ```

  ### 5. 信頼度計算
  ```javascript
  // 氏名の信頼度計算
  calculateConfidence(name, furigana) {
      let confidence = 0;
      if (name) confidence += 60;
      if (name.length >= 3 && name.length <= 8) confidence += 20;
      if (name.includes(' ')) confidence += 10;
      if (furigana) confidence += 10;
      return Math.min(confidence, 100);
  }
  ```

  ---

  ## 📊 処理フロー

  ### 1. PDF読み込み
  - ファイル読み込み
  - pdf-parseでテキスト抽出
  - デバッグ情報出力

  ### 2. 基本情報抽出
  - 氏名・フリガナ抽出
  - 年齢・電話・メール抽出
  - 信頼度計算

  ### 3. 詳細情報抽出
  - 推薦時コメント抽出
  - 職務要約抽出
  - セクション判定

  ### 4. 学歴・職歴抽出
  - 年月日パターンマッチング
  - セクション別データ収集
  - 現所属・最終学歴抽出

  ### 5. 結果統合
  - 全抽出結果の統合
  - 信頼度の最終計算
  - エラーハンドリング

  ---

  ## ⚠️ 制限事項

  ### 1. 技術的制限
  - **pdf-parse依存**: ライブラリの制限に依存
  - **テキストベース**: 画像内テキストは不可
  - **正規表現依存**: パターンマッチングに依存

  ### 2. 形式制限
  - **日本語特化**: 日本語の履歴書に特化
  - **特定フォーマット**: 一般的な履歴書フォーマットに依存
  - **ラベル依存**: 特定のラベル（氏名、年齢など）に依存

  ### 3. 精度制限
  - **文字化け**: エンコーディング問題
  - **表形式**: 複雑な表構造は不可
  - **手書き**: 手書き文字は不可

  ---

  ## 🧪 テストケース

  ### 正常系
  - 標準的な履歴書フォーマット
  - 全項目が含まれた履歴書
  - 複数ページの履歴書

  ### エラー系
  - 文字化けしたPDF
  - 画像のみのPDF
  - パスワード保護されたPDF

  ### 境界値
  - 最小限の情報のみ
  - 最大限の情報を含む
  - 特殊な文字を含む

  ---

  ## 🔄 改善予定

  ### Phase 1: 現在
  - 基本的な情報抽出
  - 文字化け修正
  - エラーハンドリング

  ### Phase 2: 検討中
  - OCR機能の追加
  - より柔軟なパターンマッチング
  - 表形式データの対応

  ### Phase 3: 将来
  - 機械学習による認識
  - より高度な自然言語処理
  - 多言語対応

  ---

  ## 📈 パフォーマンス

  ### 処理時間
  - **小さいPDF**: 1-2秒
  - **中程度のPDF**: 3-5秒
  - **大きいPDF**: 5-10秒

  ### メモリ使用量
  - **基本処理**: 10-20MB
  - **大容量PDF**: 50-100MB

  ### 成功率
  - **標準フォーマット**: 90-95%
  - **特殊フォーマット**: 70-80%
  - **文字化けPDF**: 50-60%

  ---

  **重要**: このシステムは履歴書の自動読み取りを行いますが、最終的な確認は必ず人間が行ってください。
