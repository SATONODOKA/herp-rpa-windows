<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‚äººç…§åˆRPAãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-section {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .upload-section.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        input[type="file"] {
            margin: 10px 0;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
        }
        
        .log-entry.info {
            color: #333;
        }
        
        .log-entry.success {
            color: #28a745;
            font-weight: bold;
        }
        
        .log-entry.error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .log-entry.warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .results {
            margin-top: 20px;
        }
        
        .result-section {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .result-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .result-item {
            background-color: #f8f9fa;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        
        .result-item.exact-match {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        .result-item.partial-match {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .result-item.no-match {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .extraction-details {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .safety-info {
            background-color: #f3e5f5;
            border-left-color: #9c27b0;
        }
        
        .available-jobs {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .job-item {
            padding: 5px;
            margin: 2px 0;
            background-color: white;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }
        
        .confidence-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .confidence-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        
        .confidence-fill.medium {
            background-color: #ffc107;
        }
        
        .confidence-fill.low {
            background-color: #dc3545;
        }
        
        .error-details {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .alternatives {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ±‚äººç…§åˆRPAãƒ„ãƒ¼ãƒ« (å®‰å…¨æ€§å¼·åŒ–ç‰ˆ)</h1>
        
        <div class="upload-section" id="uploadSection">
            <p>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <input type="file" id="fileInput" accept=".json" />
            <div id="fileInfo"></div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <button id="executeBtn" disabled>å®Ÿè¡Œ</button>
        <button id="closeBtn">ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹</button>
        
        <div class="results" id="results">
            <div class="result-section">
                <h3>æŠ½å‡ºæƒ…å ±</h3>
                <div id="extractionDetails"></div>
            </div>
            
            <div class="result-section">
                <h3>å…¥åŠ›ã•ã‚ŒãŸæ±‚äººå</h3>
                <div id="inputJob"></div>
            </div>
            
            <div class="result-section">
                <h3>ãƒãƒƒãƒãƒ³ã‚°çµæœ</h3>
                <div id="matchResult"></div>
            </div>
            
            <div class="result-section">
                <h3>åˆ©ç”¨å¯èƒ½ãªå‹Ÿé›†è·ç¨®</h3>
                <div id="availableJobs"></div>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let uploadedData = null;
        let eventSource = null;

        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileInfo = document.getElementById('fileInfo');
        const status = document.getElementById('status');
        const executeBtn = document.getElementById('executeBtn');
        const closeBtn = document.getElementById('closeBtn');
        const log = document.getElementById('log');
        const extractionDetailsDiv = document.getElementById('extractionDetails');
        const inputJobDiv = document.getElementById('inputJob');
        const matchResultDiv = document.getElementById('matchResult');
        const availableJobsDiv = document.getElementById('availableJobs');

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                updateStatus('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('jsonFile', file);

            try {
                updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    uploadedData = result.data;
                    updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ', 'success');
                    fileInfo.innerHTML = `<strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${file.name}<br><strong>ã‚µã‚¤ã‚º:</strong> ${file.size} bytes`;
                    executeBtn.disabled = false;
                    
                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã‚’è¡¨ç¤º
                    displayUploadedDataInfo(uploadedData);
                } else {
                    updateStatus(`ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                    executeBtn.disabled = true;
                }
            } catch (error) {
                updateStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                executeBtn.disabled = true;
            }
        }

        function displayUploadedDataInfo(data) {
            let info = '<div class="result-item"><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å½¢å¼:</strong><br>';
            
            if (data.name) {
                info += `<strong>å¾“æ¥å½¢å¼:</strong> name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ = "${data.name}"`;
            } else if (data.calib && data.calib.record && data.calib.record.ra_memo_raw) {
                info += `<strong>æ–°å½¢å¼:</strong> calib.record.ra_memo_raw<br>`;
                info += `<strong>å†…å®¹:</strong> "${data.calib.record.ra_memo_raw}"`;
            } else {
                info += '<strong>ä¸æ˜ãªå½¢å¼:</strong> èªè­˜å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            }
            
            info += '</div>';
            extractionDetailsDiv.innerHTML = info;
        }

        function updateStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function addLog(message, level = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        function clearResults() {
            inputJobDiv.innerHTML = '';
            matchResultDiv.innerHTML = '';
            availableJobsDiv.innerHTML = '';
        }

        function displayResult(result) {
            clearResults();
            
            // æŠ½å‡ºè©³ç´°ã®è¡¨ç¤º
            if (result.extractionDetails) {
                const details = result.extractionDetails;
                let extractionHtml = '<div class="result-item extraction-details">';
                extractionHtml += `<strong>æŠ½å‡ºæ–¹æ³•:</strong> ${details.method}<br>`;
                extractionHtml += `<strong>ä¿¡é ¼åº¦:</strong> ${details.confidence}%<br>`;
                
                // ä¿¡é ¼åº¦ãƒãƒ¼
                const confidenceClass = details.confidence >= 90 ? 'high' : details.confidence >= 70 ? 'medium' : 'low';
                extractionHtml += `<div class="confidence-bar">`;
                extractionHtml += `<div class="confidence-fill ${confidenceClass}" style="width: ${details.confidence}%"></div>`;
                extractionHtml += `</div>`;
                
                if (details.originalData) {
                    extractionHtml += `<strong>å…ƒãƒ‡ãƒ¼ã‚¿:</strong> "${details.originalData}"<br>`;
                }
                
                if (details.warnings && details.warnings.length > 0) {
                    extractionHtml += `<strong>è­¦å‘Š:</strong><br>`;
                    details.warnings.forEach(warning => {
                        extractionHtml += `â€¢ ${warning}<br>`;
                    });
                }
                
                extractionHtml += '</div>';
                extractionDetailsDiv.innerHTML = extractionHtml;
            }
            
            // å…¥åŠ›ã•ã‚ŒãŸæ±‚äººå
            inputJobDiv.innerHTML = `<div class="result-item">${result.inputJobName}</div>`;
            
            // ãƒãƒƒãƒãƒ³ã‚°çµæœã®è©³ç´°è¡¨ç¤º
            let matchHtml = '';
            
            if (result.matchType === 'exact') {
                matchHtml = `
                    <div class="result-item exact-match">
                        <strong>å®Œå…¨ä¸€è‡´</strong><br>
                        å‹Ÿé›†è·ç¨®: ${result.matchedJob}<br>
                        <strong>ä¿¡é ¼åº¦:</strong> ${result.confidence || 100}%
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${result.confidence || 100}%"></div>
                        </div>
                        <small style="color: #155724;">æ–‡å­—é€šã‚Šå®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ã¾ã™</small>
                    </div>`;
            } else if (result.matchType === 'normalized_exact') {
                matchHtml = `
                    <div class="result-item exact-match">
                        <strong>æ­£è¦åŒ–å¾Œå®Œå…¨ä¸€è‡´</strong><br>
                        å‹Ÿé›†è·ç¨®: ${result.matchedJob}<br>
                        <strong>ä¿¡é ¼åº¦:</strong> ${result.confidence || 95}%
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${result.confidence || 95}%"></div>
                        </div>
                        <small style="color: #155724;">ã‚¹ãƒšãƒ¼ã‚¹ã‚„è¨˜å·ã‚’çµ±ä¸€å¾Œã«å®Œå…¨ä¸€è‡´ã—ã¦ã„ã¾ã™</small>
                    </div>`;
            } else if (result.matchType === 'core_exact') {
                matchHtml = `
                    <div class="result-item exact-match">
                        <strong>è£…é£¾é™¤å»å¾Œå®Œå…¨ä¸€è‡´</strong><br>
                        å‹Ÿé›†è·ç¨®: ${result.matchedJob}<br>
                        <strong>ä¿¡é ¼åº¦:</strong> ${result.confidence || 90}%
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${result.confidence || 90}%"></div>
                        </div>
                        <small style="color: #155724;">è£…é£¾æ–‡å­—ï¼ˆã€ã€‘ãªã©ï¼‰ã‚’é™¤å»å¾Œã«å®Œå…¨ä¸€è‡´ã—ã¦ã„ã¾ã™</small>
                    </div>`;
            } else if (result.matchType === 'strict_subset') {
                matchHtml = `
                    <div class="result-item partial-match">
                        <strong>å³æ ¼ãªéƒ¨åˆ†ä¸€è‡´ï¼ˆæ‹’å¦ï¼‰</strong><br>
                        å‹Ÿé›†è·ç¨®: ${result.matchedJob}<br>
                        <strong>ä¿¡é ¼åº¦:</strong> ${result.confidence || 85}% â†’ 0% (æ‹’å¦)
                        <div class="confidence-bar">
                            <div class="confidence-fill low" style="width: 0%"></div>
                        </div>
                        <small style="color: #856404;">éƒ¨åˆ†ä¸€è‡´ã‚’æ¤œå‡ºã—ã¾ã—ãŸãŒã€å®‰å…¨æ€§ã®ãŸã‚æ‹’å¦ã•ã‚Œã¾ã—ãŸ</small>
                    </div>`;
            } else {
                matchHtml = `
                    <div class="result-item no-match">
                        <strong>è©²å½“ãªã—</strong><br>
                        <small style="color: #999;">
                            ã€Œ${result.inputJobName}ã€ã«å³æ ¼ãªæ¡ä»¶ã§ãƒãƒƒãƒã™ã‚‹å‹Ÿé›†è·ç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
                        </small>
                    </div>`;
                
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã®è¡¨ç¤º
                if (result.errors && result.errors.length > 0) {
                    matchHtml += '<div class="error-details"><strong>ã‚¨ãƒ©ãƒ¼è©³ç´°:</strong><br>';
                    result.errors.forEach(error => {
                        matchHtml += `â€¢ ${error}<br>`;
                    });
                    matchHtml += '</div>';
                }
                
                // ä»£æ›¿å€™è£œã®è¡¨ç¤º
                if (result.alternatives && result.alternatives.length > 0) {
                    matchHtml += '<div class="alternatives"><strong>é¡ä¼¼å€™è£œ:</strong><br>';
                    result.alternatives.forEach(alt => {
                        matchHtml += `â€¢ ${alt}<br>`;
                    });
                    matchHtml += '</div>';
                }
            }
            
            // ãƒãƒƒãƒãƒ³ã‚°è©³ç´°æƒ…å ±ã®è¡¨ç¤º
            if (result.details && result.details.checkedJobs) {
                matchHtml += '<div class="result-item safety-info">';
                matchHtml += '<strong>ãƒãƒƒãƒãƒ³ã‚°è©³ç´°:</strong><br>';
                matchHtml += `<strong>æ­£è¦åŒ–å¾Œ:</strong> "${result.details.normalizedExtracted}"<br>`;
                matchHtml += `<strong>è£…é£¾é™¤å»å¾Œ:</strong> "${result.details.coreExtracted}"<br>`;
                matchHtml += `<strong>ãƒã‚§ãƒƒã‚¯æ¸ˆã¿æ±‚äººæ•°:</strong> ${result.details.checkedJobs.length}ä»¶<br>`;
                
                // å…¨ãƒãƒƒãƒã®æ¦‚è¦è¡¨ç¤º
                if (result.details.allMatches && result.details.allMatches.length > 0) {
                    matchHtml += `<strong>ãƒãƒƒãƒã—ãŸæ±‚äºº:</strong> ${result.details.allMatches.length}ä»¶<br>`;
                    
                    // ãƒãƒƒãƒã‚¿ã‚¤ãƒ—åˆ¥ã®é›†è¨ˆ
                    const matchTypeCount = {};
                    result.details.allMatches.forEach(match => {
                        matchTypeCount[match.type] = (matchTypeCount[match.type] || 0) + 1;
                    });
                    
                    Object.entries(matchTypeCount).forEach(([type, count]) => {
                        const typeNames = {
                            'exact': 'å®Œå…¨ä¸€è‡´',
                            'normalized_exact': 'æ­£è¦åŒ–å¾Œä¸€è‡´',
                            'core_exact': 'è£…é£¾é™¤å»å¾Œä¸€è‡´',
                            'strict_subset': 'éƒ¨åˆ†ä¸€è‡´'
                        };
                        matchHtml += `â€¢ ${typeNames[type] || type}: ${count}ä»¶<br>`;
                    });
                }
                
                if (result.details.checkedJobs.length > 0) {
                    matchHtml += '<details style="margin-top: 10px;"><summary>è©³ç´°ãªãƒã‚§ãƒƒã‚¯çµæœ</summary>';
                    matchHtml += '<div style="max-height: 200px; overflow-y: auto; margin-top: 5px;">';
                    result.details.checkedJobs.forEach((jobCheck, index) => {
                        const statusColor = jobCheck.confidence > 0 ? '#28a745' : '#6c757d';
                        const isMatched = jobCheck.confidence > 0;
                        matchHtml += `<div style="border-left: 3px solid ${statusColor}; padding-left: 8px; margin: 5px 0; ${isMatched ? 'background-color: #f8f9fa;' : ''}">`;
                        matchHtml += `<strong>${index + 1}. ${jobCheck.original}</strong>`;
                        if (isMatched) {
                            matchHtml += ` <span style="color: ${statusColor}; font-weight: bold;">âœ“ MATCH</span>`;
                        }
                        matchHtml += `<br>`;
                        matchHtml += `æ­£è¦åŒ–: "${jobCheck.normalized}"<br>`;
                        matchHtml += `è£…é£¾é™¤å»: "${jobCheck.core}"<br>`;
                        matchHtml += `çµæœ: ${jobCheck.matchType || 'no_match'} (${jobCheck.confidence}%)`;
                        matchHtml += `</div>`;
                    });
                    matchHtml += '</div></details>';
                }
                matchHtml += '</div>';
            }
            
            // è¤‡æ•°ãƒãƒƒãƒã®å±é™ºæ€§è­¦å‘Š
            if (result.alternatives && result.alternatives.length > 1) {
                matchHtml += '<div class="result-item" style="background-color: #f8d7da; border-left-color: #dc3545;">';
                matchHtml += '<strong>ğŸš¨ è¤‡æ•°ãƒãƒƒãƒæ¤œå‡ºï¼ˆå±é™ºï¼‰:</strong><br>';
                matchHtml += `${result.alternatives.length}ä»¶ã®æ±‚äººãŒãƒãƒƒãƒã—ã¾ã—ãŸã€‚å®‰å…¨æ€§ã®ãŸã‚å‡¦ç†ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚<br><br>`;
                matchHtml += '<strong>ãƒãƒƒãƒã—ãŸæ±‚äºº:</strong><br>';
                result.alternatives.forEach((alt, index) => {
                    matchHtml += `${index + 1}. ${alt}<br>`;
                });
                matchHtml += '<br><small style="color: #721c24;">è¤‡æ•°ã®æ±‚äººã«ãƒãƒƒãƒã™ã‚‹å ´åˆã€é–“é•ã£ãŸæ±‚äººã«å¿œå‹Ÿã™ã‚‹å±é™ºæ€§ãŒã‚ã‚‹ãŸã‚ã€æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>';
                matchHtml += '</div>';
            }
            
            // è­¦å‘Šã®è¡¨ç¤º
            if (result.warnings && result.warnings.length > 0) {
                matchHtml += '<div class="result-item" style="background-color: #fff3cd; border-left-color: #ffc107;">';
                matchHtml += '<strong>è­¦å‘Š:</strong><br>';
                result.warnings.forEach(warning => {
                    matchHtml += `â€¢ ${warning}<br>`;
                });
                matchHtml += '</div>';
            }
            
            matchResultDiv.innerHTML = matchHtml;
            
            // åˆ©ç”¨å¯èƒ½ãªå‹Ÿé›†è·ç¨®
            if (result.availableJobs && result.availableJobs.length > 0) {
                let jobsHtml = `<div class="available-jobs">`;
                jobsHtml += `<strong>å–å¾—ã•ã‚ŒãŸå‹Ÿé›†è·ç¨® (${result.availableJobs.length}ä»¶):</strong><br>`;
                result.availableJobs.forEach(job => {
                    jobsHtml += `<div class="job-item">${job}</div>`;
                });
                jobsHtml += '</div>';
                availableJobsDiv.innerHTML = jobsHtml;
            }
        }

        closeBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/close', {
                    method: 'POST'
                });
                const result = await response.json();
                addLog(result.message, 'success');
            } catch (error) {
                addLog(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });

        executeBtn.addEventListener('click', async () => {
            if (!uploadedData) {
                addLog('JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            executeBtn.disabled = true;
            clearResults();
            updateStatus('å®Ÿè¡Œä¸­...', 'info');
            addLog('å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');

            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/events');
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'log') {
                    addLog(data.message, data.level || 'info');
                } else if (data.type === 'result') {
                    displayResult(data.result);
                    addLog('åˆ¤å®šå®Œäº†', 'success');
                } else if (data.type === 'complete') {
                    updateStatus('å®Œäº†', 'success');
                    executeBtn.disabled = false;
                }
            };

            eventSource.onerror = () => {
                addLog('æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
                updateStatus('ã‚¨ãƒ©ãƒ¼', 'error');
                executeBtn.disabled = false;
                eventSource.close();
            };

            try {
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: uploadedData })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    addLog(`å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                    if (result.details) {
                        result.details.forEach(detail => {
                            addLog(`è©³ç´°: ${detail}`, 'error');
                        });
                    }
                    updateStatus('ã‚¨ãƒ©ãƒ¼', 'error');
                    executeBtn.disabled = false;
                }
            } catch (error) {
                addLog(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('ã‚¨ãƒ©ãƒ¼', 'error');
                executeBtn.disabled = false;
            }
        });

        // åˆæœŸåŒ–
        addLog('æ±‚äººç…§åˆRPAãƒ„ãƒ¼ãƒ« (å®‰å…¨æ€§å¼·åŒ–ç‰ˆ) ãŒèµ·å‹•ã—ã¾ã—ãŸ');
        addLog('æ–°ã—ã„JSONæ›¸å¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™');
    </script>
</body>
</html>