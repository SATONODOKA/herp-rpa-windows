<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‚äººç…§åˆRPAãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-section {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .upload-section.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .file-group {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fefefe;
        }
        
        .file-group h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .file-group p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .mapping-table th,
        .mapping-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .mapping-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .source-pdf {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .source-raã‚³ãƒ¡ãƒ³ãƒˆ {
            background-color: #fff3e0;
            color: #f57c00;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .confidence.high-confidence {
            color: #2e7d32;
            font-weight: bold;
        }
        
        .confidence.medium-confidence {
            color: #f57c00;
            font-weight: bold;
        }
        
        .confidence.low-confidence {
            color: #d32f2f;
            font-weight: bold;
        }
        
        .analysis-section,
        .mapping-section {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fafafa;
        }
        
        .analysis-summary,
        .mapping-summary {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .pdf-data p {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        input[type="file"] {
            margin: 10px 0;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
        }
        
        .log-entry.info {
            color: #333;
        }
        
        .log-entry.success {
            color: #28a745;
            font-weight: bold;
        }
        
        .log-entry.error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .log-entry.warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .results {
            margin-top: 20px;
        }
        
        .result-section {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .result-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .result-item {
            background-color: #f8f9fa;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        
        .result-item.exact-match {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        .result-item.partial-match {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .result-item.no-match {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .extraction-details {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .safety-info {
            background-color: #f3e5f5;
            border-left-color: #9c27b0;
        }
        
        .available-jobs {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .job-item {
            padding: 5px;
            margin: 2px 0;
            background-color: white;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }
        
        .confidence-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .confidence-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        
        .confidence-fill.medium {
            background-color: #ffc107;
        }
        
        .confidence-fill.low {
            background-color: #dc3545;
        }
        
        .error-details {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .alternatives {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .form-analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .form-analysis-table th,
        .form-analysis-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .form-analysis-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .form-analysis-table .required {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        
        .form-analysis-table .optional {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .field-row.required {
            background-color: #fff5f5;
        }

        .field-row.optional {
            background-color: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 5px;
        }

        .required-badge {
            background-color: #dc3545;
            color: white;
        }

        .optional-badge {
            background-color: #6c757d;
            color: white;
        }

        .field-type {
            background-color: #e3f2fd;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            color: #1976d2;
            font-weight: bold;
        }
        
        .form-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .form-summary-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border-left: 4px solid #6c757d;
        }
        
        .form-summary-item.required {
            border-left-color: #dc3545;
        }
        
        .form-summary-item.optional {
            border-left-color: #17a2b8;
        }
        
        .form-summary-item.total {
            border-left-color: #28a745;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .error-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
        }

        .error-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }

        .error-popup-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            color: #dc3545;
        }

        .error-popup-icon {
            font-size: 48px;
            margin-right: 15px;
        }

        .error-popup-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .error-popup-message {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }

        .error-popup-details {
            background-color: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }

        .error-popup-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
        }

        .error-popup-button:hover {
            background-color: #c82333;
        }

        .processing-stopped {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
            color: #856404 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ±‚äººç…§åˆRPAãƒ„ãƒ¼ãƒ« (rirekishoç‰¹åŒ–ç‰ˆ)</h1>
        
        <div class="upload-section" id="uploadSection">
            <h2>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            
            <!-- JSON ãƒ•ã‚¡ã‚¤ãƒ« -->
            <div class="file-group">
                <h3>ğŸ“‹ JSONãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¿…é ˆï¼‰</h3>
                <p>æ±‚äººæƒ…å ±ã¨RAã‚³ãƒ¡ãƒ³ãƒˆã‚’å«ã‚€JSONãƒ•ã‚¡ã‚¤ãƒ«</p>
                <input type="file" id="fileInput" accept=".json" />
                <div id="fileInfo" class="file-info"></div>
            </div>
            
            <!-- PDF ãƒ•ã‚¡ã‚¤ãƒ« -->
            <div class="file-group">
                <h3>ğŸ“‘ å±¥æ­´æ›¸PDFï¼ˆå¿…é ˆï¼‰</h3>
                <p>rirekishoå½¢å¼ã®å±¥æ­´æ›¸PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œ</p>
                <input type="file" id="pdfInput" accept=".pdf" />
                <div id="pdfInfo" class="file-info"></div>
            </div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <button id="executeBtn" disabled>å®Ÿè¡Œ</button>
        <button id="closeBtn">ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹</button>
        
        <div class="results" id="results">
            <div class="result-section">
                <h3>æŠ½å‡ºæƒ…å ±</h3>
                <div id="extractionDetails"></div>
            </div>
            
            <div class="result-section">
                <h3>å…¥åŠ›ã•ã‚ŒãŸæ±‚äººå</h3>
                <div id="inputJob"></div>
            </div>
            
            <div class="result-section">
                <h3>ãƒãƒƒãƒãƒ³ã‚°çµæœ</h3>
                <div id="matchResult"></div>
            </div>
            
            <div class="result-section">
                <h3>åˆ©ç”¨å¯èƒ½ãªå‹Ÿé›†è·ç¨®</h3>
                <div id="availableJobs"></div>
            </div>
            
            <div class="result-section">
                <h3>ãƒ•ã‚©ãƒ¼ãƒ è§£æçµæœ</h3>
                <div id="formAnalysis"></div>
            </div>
            
            <div class="result-section">
                <h3>PDFè§£æçµæœ</h3>
                <div id="pdfAnalysis"></div>
            </div>
            
            <div class="result-section">
                <h3>å¿…é ˆé …ç›®ã¨å…¥åŠ›ãƒ‡ãƒ¼ã‚¿</h3>
                <div id="requiredFieldsData"></div>
            </div>
        </div>
        
        <!-- HERPã«ç™»éŒ²ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
        <div class="result-section" id="herpRegistrationSection" style="display: none;">
            <h3>ğŸš€ HERPã¸ã®è‡ªå‹•è»¢è¨˜</h3>
            <div class="result-item" style="background-color: #e8f5e8; border-left-color: #28a745;">
                <p><strong>è‡ªå‹•è»¢è¨˜æ©Ÿèƒ½</strong></p>
                <p>è§£æçµæœã‚’HERPãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•è»¢è¨˜ã—ã¾ã™ã€‚å¿…é ˆé …ç›®ã®ã¿ãŒè»¢è¨˜ã•ã‚Œã€å±¥æ­´æ›¸PDFã‚‚è‡ªå‹•ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</p>
                <button id="registerToHerpBtn" style="background-color: #28a745; font-size: 18px; padding: 15px 30px; margin-top: 10px;">
                    ğŸ“ HERPã«ç™»éŒ²ã™ã‚‹
                </button>
                <button id="errorCheckBtn" style="background-color: #007bff; font-size: 18px; padding: 15px 30px; margin-top: 10px; margin-left: 10px; display: none;">
                    ğŸ” ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã™ã‚‹
                </button>
                <div id="herpRegistrationStatus" style="margin-top: 10px; display: none;"></div>
                <div id="errorCheckStatus" style="margin-top: 10px; display: none;"></div>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="error-popup-overlay" id="errorPopupOverlay">
        <div class="error-popup">
            <div class="error-popup-header">
                <div class="error-popup-icon">ğŸš¨</div>
                <h2 class="error-popup-title">å‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
            </div>
            <div class="error-popup-message" id="errorPopupMessage">
                ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
            <div class="error-popup-details" id="errorPopupDetails" style="display: none;">
                è©³ç´°æƒ…å ±
            </div>
            <button class="error-popup-button" onclick="closeErrorPopup()">
                OK - å‡¦ç†ã‚’åœæ­¢ã—ã¾ã™
            </button>
        </div>
    </div>

    <script>
        let uploadedData = null;
        let uploadedPdf = null;
        let eventSource = null;
        let herpRegistrationCompleted = false;
        let processingAborted = false;

        const fileInput = document.getElementById('fileInput');
        const pdfInput = document.getElementById('pdfInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileInfo = document.getElementById('fileInfo');
        const pdfInfo = document.getElementById('pdfInfo');
        const status = document.getElementById('status');
        const executeBtn = document.getElementById('executeBtn');
        const closeBtn = document.getElementById('closeBtn');
        const log = document.getElementById('log');
        const extractionDetailsDiv = document.getElementById('extractionDetails');
        const inputJobDiv = document.getElementById('inputJob');
        const matchResultDiv = document.getElementById('matchResult');
        const availableJobsDiv = document.getElementById('availableJobs');

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // PDFãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        pdfInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePdfFile(e.target.files[0]);
            }
        });

        async function handlePdfFile(file) {
            if (!file.name.endsWith('.pdf')) {
                updateStatus('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                updateStatus('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠä¸­...', 'info');
                uploadedPdf = file;
                pdfInfo.innerHTML = `<strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${file.name}<br><strong>ã‚µã‚¤ã‚º:</strong> ${(file.size / 1024).toFixed(1)} KB`;
                updateStatus('PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ', 'success');
                
                // ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                checkFilesReady();
            } catch (error) {
                updateStatus(`PDFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                executeBtn.disabled = true;
            }
        }

        // ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæº–å‚™ã§ãã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function checkFilesReady() {
            executeBtn.disabled = !(uploadedData && uploadedPdf);
            if (uploadedData && uploadedPdf) {
                updateStatus('ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸã€‚å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
            }
        }

        async function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                updateStatus('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('jsonFile', file);

            try {
                updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    uploadedData = result.data;
                    updateStatus('JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ', 'success');
                    fileInfo.innerHTML = `<strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${file.name}<br><strong>ã‚µã‚¤ã‚º:</strong> ${file.size} bytes`;
                    
                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã‚’è¡¨ç¤º
                    displayUploadedDataInfo(uploadedData);
                    
                    // ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    checkFilesReady();
                } else {
                    updateStatus(`ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                    executeBtn.disabled = true;
                }
            } catch (error) {
                updateStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                executeBtn.disabled = true;
            }
        }

        function displayUploadedDataInfo(data) {
            let info = '<div class="result-item"><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å½¢å¼:</strong><br>';
            
            if (data.name) {
                info += `<strong>å¾“æ¥å½¢å¼:</strong> name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ = "${data.name}"`;
            } else if (data.calib && data.calib.record && data.calib.record.ra_memo_raw) {
                info += `<strong>æ–°å½¢å¼:</strong> calib.record.ra_memo_raw<br>`;
                info += `<strong>å†…å®¹:</strong> "${data.calib.record.ra_memo_raw}"`;
            } else {
                info += '<strong>ä¸æ˜ãªå½¢å¼:</strong> èªè­˜å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            }
            
            info += '</div>';
            extractionDetailsDiv.innerHTML = info;
        }

        function updateStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function addLog(message, level = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        function clearResults() {
            inputJobDiv.innerHTML = '';
            matchResultDiv.innerHTML = '';
            availableJobsDiv.innerHTML = '';
        }

        function displayResult(result) {
            clearResults();
            
            // æŠ½å‡ºè©³ç´°ã®è¡¨ç¤º
            if (result.extractionDetails) {
                const details = result.extractionDetails;
                let extractionHtml = '<div class="result-item extraction-details">';
                extractionHtml += `<strong>æŠ½å‡ºæ–¹æ³•:</strong> ${details.method}<br>`;
                extractionHtml += `<strong>ä¿¡é ¼åº¦:</strong> ${details.confidence}%<br>`;
                
                // ä¿¡é ¼åº¦ãƒãƒ¼
                const confidenceClass = details.confidence >= 90 ? 'high' : details.confidence >= 70 ? 'medium' : 'low';
                extractionHtml += `<div class="confidence-bar">`;
                extractionHtml += `<div class="confidence-fill ${confidenceClass}" style="width: ${details.confidence}%"></div>`;
                extractionHtml += `</div>`;
                
                if (details.originalData) {
                    extractionHtml += `<strong>å…ƒãƒ‡ãƒ¼ã‚¿:</strong> "${details.originalData}"<br>`;
                }
                
                if (details.warnings && details.warnings.length > 0) {
                    extractionHtml += `<strong>è­¦å‘Š:</strong><br>`;
                    details.warnings.forEach(warning => {
                        extractionHtml += `â€¢ ${warning}<br>`;
                    });
                }
                
                extractionHtml += '</div>';
                extractionDetailsDiv.innerHTML = extractionHtml;
            }
            
            // å…¥åŠ›ã•ã‚ŒãŸæ±‚äººå
            inputJobDiv.innerHTML = `<div class="result-item">${result.inputJobName}</div>`;
            
            // ãƒãƒƒãƒãƒ³ã‚°çµæœã®è©³ç´°è¡¨ç¤º
            let matchHtml = '';
            
            if (result.matchType === 'exact') {
                matchHtml = `
                    <div class="result-item exact-match">
                        <strong>å®Œå…¨ä¸€è‡´</strong><br>
                        å‹Ÿé›†è·ç¨®: ${result.matchedJob}<br>
                        <strong>ä¿¡é ¼åº¦:</strong> ${result.confidence || 100}%
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${result.confidence || 100}%"></div>
                        </div>
                        <small style="color: #155724;">æ–‡å­—é€šã‚Šå®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ã¾ã™</small>
                    </div>`;
            } else if (result.matchType === 'normalized_exact') {
                matchHtml = `
                    <div class="result-item exact-match">
                        <strong>æ­£è¦åŒ–å¾Œå®Œå…¨ä¸€è‡´</strong><br>
                        å‹Ÿé›†è·ç¨®: ${result.matchedJob}<br>
                        <strong>ä¿¡é ¼åº¦:</strong> ${result.confidence || 95}%
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${result.confidence || 95}%"></div>
                        </div>
                        <small style="color: #155724;">ã‚¹ãƒšãƒ¼ã‚¹ã‚„è¨˜å·ã‚’çµ±ä¸€å¾Œã«å®Œå…¨ä¸€è‡´ã—ã¦ã„ã¾ã™</small>
                    </div>`;
            } else if (result.matchType === 'core_exact') {
                matchHtml = `
                    <div class="result-item exact-match">
                        <strong>è£…é£¾é™¤å»å¾Œå®Œå…¨ä¸€è‡´</strong><br>
                        å‹Ÿé›†è·ç¨®: ${result.matchedJob}<br>
                        <strong>ä¿¡é ¼åº¦:</strong> ${result.confidence || 90}%
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${result.confidence || 90}%"></div>
                        </div>
                        <small style="color: #155724;">è£…é£¾æ–‡å­—ï¼ˆã€ã€‘ãªã©ï¼‰ã‚’é™¤å»å¾Œã«å®Œå…¨ä¸€è‡´ã—ã¦ã„ã¾ã™</small>
                    </div>`;
            } else if (result.matchType === 'strict_subset') {
                matchHtml = `
                    <div class="result-item partial-match">
                        <strong>å³æ ¼ãªéƒ¨åˆ†ä¸€è‡´ï¼ˆæ‹’å¦ï¼‰</strong><br>
                        å‹Ÿé›†è·ç¨®: ${result.matchedJob}<br>
                        <strong>ä¿¡é ¼åº¦:</strong> ${result.confidence || 85}% â†’ 0% (æ‹’å¦)
                        <div class="confidence-bar">
                            <div class="confidence-fill low" style="width: 0%"></div>
                        </div>
                        <small style="color: #856404;">éƒ¨åˆ†ä¸€è‡´ã‚’æ¤œå‡ºã—ã¾ã—ãŸãŒã€å®‰å…¨æ€§ã®ãŸã‚æ‹’å¦ã•ã‚Œã¾ã—ãŸ</small>
                    </div>`;
            } else {
                matchHtml = `
                    <div class="result-item no-match">
                        <strong>è©²å½“ãªã—</strong><br>
                        <small style="color: #999;">
                            ã€Œ${result.inputJobName}ã€ã«å³æ ¼ãªæ¡ä»¶ã§ãƒãƒƒãƒã™ã‚‹å‹Ÿé›†è·ç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
                        </small>
                    </div>`;
                
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã®è¡¨ç¤º
                if (result.errors && result.errors.length > 0) {
                    matchHtml += '<div class="error-details"><strong>ã‚¨ãƒ©ãƒ¼è©³ç´°:</strong><br>';
                    result.errors.forEach(error => {
                        matchHtml += `â€¢ ${error}<br>`;
                    });
                    matchHtml += '</div>';
                }
                
                // ä»£æ›¿å€™è£œã®è¡¨ç¤º
                if (result.alternatives && result.alternatives.length > 0) {
                    matchHtml += '<div class="alternatives"><strong>é¡ä¼¼å€™è£œ:</strong><br>';
                    result.alternatives.forEach(alt => {
                        matchHtml += `â€¢ ${alt}<br>`;
                    });
                    matchHtml += '</div>';
                }
            }
            
            matchResultDiv.innerHTML = matchHtml;
            
            // åˆ©ç”¨å¯èƒ½ãªå‹Ÿé›†è·ç¨®
            if (result.availableJobs && result.availableJobs.length > 0) {
                let jobsHtml = `<div class="available-jobs">`;
                jobsHtml += `<strong>å–å¾—ã•ã‚ŒãŸå‹Ÿé›†è·ç¨® (${result.availableJobs.length}ä»¶):</strong><br>`;
                result.availableJobs.forEach(job => {
                    jobsHtml += `<div class="job-item">${job}</div>`;
                });
                jobsHtml += '</div>';
                availableJobsDiv.innerHTML = jobsHtml;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ è§£æçµæœã®è¡¨ç¤º
            console.log('ãƒ•ã‚©ãƒ¼ãƒ è§£æçµæœ:', result.formAnalysis);
            displayFormAnalysis(result.formAnalysis);
            
            // PDFè§£æçµæœã®è¡¨ç¤º
            if (result.formAnalysis && result.formAnalysis.pdfAnalysis) {
                displayPdfAnalysis(result.formAnalysis.pdfAnalysis);
            }
            
            // å¿…é ˆé …ç›®ã¨ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°ã®è¡¨ç¤º
            if (result.formAnalysis && result.formAnalysis.dataMapping) {
                displayRequiredFieldsData(result.formAnalysis.dataMapping);
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•å…¥åŠ›æ©Ÿèƒ½ã¯å‰Šé™¤ï¼ˆHERPã‚µã‚¤ãƒˆã¸ã®ç›´æ¥å…¥åŠ›ã¯è¡Œã‚ãªã„ï¼‰

            // HERPç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã€enhanced JSONãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            if (result.formAnalysis && result.formAnalysis.enhancedJson && result.formAnalysis.enhancedJson.success) {
                latestEnhancedData = result.formAnalysis.enhancedJson.data;
                latestPdfFile = uploadedPdf; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸPDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
                
                const herpSection = document.getElementById('herpRegistrationSection');
                herpSection.style.display = 'block';
                
                // enhanced JSONãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°ã‚’è¡¨ç¤º
                const herpStatusDiv = document.getElementById('herpRegistrationStatus');
                herpStatusDiv.innerHTML = `
                    <div class="result-item" style="background-color: #f0f8ff; border-left-color: #007bff;">
                        <strong>ğŸ“Š è»¢è¨˜æº–å‚™å®Œäº†</strong><br>
                        <small>Enhanced JSON: ${result.formAnalysis.enhancedJson.fileName}</small><br>
                        <small>è»¢è¨˜å¯èƒ½é …ç›®: ${Object.keys(latestEnhancedData.formData).length}å€‹</small><br>
                        <small>å±¥æ­´æ›¸PDF: ${uploadedPdf.name}</small>
                    </div>
                `;
                herpStatusDiv.style.display = 'block';
                
                // è‡ªå‹•ã§HERPè»¢è¨˜ã¨ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
                setTimeout(async () => {
                    await executeAutoHerpRegistration();
                }, 1500); // 1.5ç§’å¾…ã£ã¦ã‹ã‚‰è‡ªå‹•å®Ÿè¡Œ
            }
        }
        
        function displayFormAnalysis(formAnalysis) {
            const formAnalysisDiv = document.getElementById('formAnalysis');
            console.log('displayFormAnalysiså‘¼ã³å‡ºã—:', formAnalysis);
            
            if (!formAnalysis) {
                formAnalysisDiv.innerHTML = '<div class="result-item">ãƒ•ã‚©ãƒ¼ãƒ è§£æã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>';
                return;
            }
            
            if (!formAnalysis.success) {
                formAnalysisDiv.innerHTML = `
                    <div class="result-item no-match">
                        <strong>ãƒ•ã‚©ãƒ¼ãƒ è§£æå¤±æ•—</strong><br>
                        ${formAnalysis.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}
                    </div>`;
                return;
            }
            
            let formHtml = '';
            
            // æ¦‚è¦æƒ…å ±
            formHtml += '<div class="result-item" style="background-color: #e3f2fd; border-left-color: #2196f3;">';
            formHtml += '<strong>ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ è§£ææ¦‚è¦</strong><br>';
            if (formAnalysis.companyName) {
                formHtml += `<strong>ä¼šç¤¾å:</strong> ${formAnalysis.companyName}<br>`;
            }
            formHtml += `<strong>æ±‚äºº:</strong> ${formAnalysis.jobName}<br>`;
            formHtml += `<strong>è§£ææ™‚åˆ»:</strong> ${new Date(formAnalysis.timestamp).toLocaleString('ja-JP')}<br>`;
            if (formAnalysis.savedFile && formAnalysis.savedFile.success) {
                formHtml += `<strong>ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${formAnalysis.savedFile.fileName}<br>`;
            }
            formHtml += '</div>';
            
            // è¿½åŠ å¿…é ˆé …ç›®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰æƒ…å ±ã®è¡¨ç¤º
            if (formAnalysis.additionalRequiredOverrides && formAnalysis.additionalRequiredOverrides.specifiedFields.length > 0) {
                formHtml += '<div class="result-item" style="background-color: #fff3e0; border-left-color: #ff9800;">';
                formHtml += '<strong>ğŸ”§ è¿½åŠ å¿…é ˆé …ç›®ã«ã‚ˆã‚‹ä¸Šæ›¸ã</strong><br>';
                
                // JSONæŒ‡å®šé …ç›®ã¨RAã‚³ãƒ¡ãƒ³ãƒˆé …ç›®ã‚’åˆ†ã‘ã¦è¡¨ç¤º
                const jsonFields = formAnalysis.additionalRequiredOverrides.specifiedFields.filter(field => 
                    !formAnalysis.additionalRequiredOverrides.raCommentFields || 
                    !formAnalysis.additionalRequiredOverrides.raCommentFields.includes(field)
                );
                const raFields = formAnalysis.additionalRequiredOverrides.raCommentFields || [];
                
                if (jsonFields.length > 0) {
                    formHtml += `<strong>JSONæŒ‡å®šé …ç›®:</strong> ${jsonFields.join(', ')}<br>`;
                }
                if (raFields.length > 0) {
                    formHtml += `<strong>RAã‚³ãƒ¡ãƒ³ãƒˆæ¤œå‡ºé …ç›®:</strong> ${raFields.join(', ')}<br>`;
                }
                
                formHtml += `<strong>é©ç”¨ä»¶æ•°:</strong> ${formAnalysis.additionalRequiredOverrides.appliedCount}ä»¶<br>`;
                
                if (formAnalysis.additionalRequiredOverrides.appliedFields && formAnalysis.additionalRequiredOverrides.appliedFields.length > 0) {
                    formHtml += '<strong>é©ç”¨çµæœ:</strong><br>';
                    formAnalysis.additionalRequiredOverrides.appliedFields.forEach(applied => {
                        formHtml += `&nbsp;&nbsp;â€¢ ã€Œ${applied.fieldName}ã€â†’ å¿…é ˆã«å¤‰æ›´ï¼ˆæŒ‡å®š: ${applied.overriddenBy}ï¼‰<br>`;
                    });
                }
                
                formHtml += '</div>';
            }
            
            // æœ‰åŠ¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã§çµ±è¨ˆã‚’è¨ˆç®—
            const validFields = formAnalysis.fields ? formAnalysis.fields.filter(field => 
                field.name !== 'Unknown Field' && field.name.trim() !== ''
            ) : [];
            
            const validTotalFields = validFields.length;
            const validRequiredFields = validFields.filter(field => field.required).length;
            const validOptionalFields = validFields.filter(field => !field.required).length;
            
            // ã‚µãƒãƒªãƒ¼ï¼ˆæœ‰åŠ¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ï¼‰
            formHtml += '<div class="form-summary">';
            formHtml += `
                <div class="form-summary-item total">
                    <strong>${validTotalFields}</strong><br>
                    <small>æœ‰åŠ¹é …ç›®æ•°</small>
                </div>
                <div class="form-summary-item required">
                    <strong>${validRequiredFields}</strong><br>
                    <small>å¿…é ˆé …ç›®</small>
                </div>
                <div class="form-summary-item optional">
                    <strong>${validOptionalFields}</strong><br>
                    <small>ä»»æ„é …ç›®</small>
                </div>
            `;
            
            if (validTotalFields > 0) {
                const requiredPercentage = Math.round((validRequiredFields / validTotalFields) * 100);
                formHtml += `
                    <div class="form-summary-item">
                        <strong>${requiredPercentage}%</strong><br>
                        <small>å¿…é ˆé …ç›®ç‡</small>
                    </div>
                `;
            }
            formHtml += '</div>';
            
            // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆUnknown Fieldã‚’é™¤å¤–ï¼‰
            if (formAnalysis.fields && formAnalysis.fields.length > 0) {
                // Unknown Fieldã‚’é™¤å¤–ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const validFields = formAnalysis.fields.filter(field => 
                    field.name !== 'Unknown Field' && field.name.trim() !== ''
                );
                
                if (validFields.length > 0) {
                    formHtml += '<div class="result-item">';
                    formHtml += `<strong>ğŸ“ é …ç›®è©³ç´°ä¸€è¦§ (${validFields.length}ä»¶ã®æœ‰åŠ¹é …ç›®)</strong><br><br>`;
                    formHtml += '<table class="form-analysis-table">';
                    formHtml += `
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>é …ç›®å</th>
                                <th>ç¨®é¡</th>
                                <th>å¿…é ˆ/ä»»æ„</th>
                                <th>æ¤œå‡ºæ–¹æ³•</th>
                                <th>è©³ç´°æƒ…å ±</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    validFields.forEach((field, index) => {
                        const statusClass = field.required ? 'required' : 'optional';
                        const statusText = field.required ? 'ğŸ”´ å¿…é ˆ' : 'âšª ä»»æ„';
                        const statusBadge = field.required ? 
                            '<span class="badge required-badge">å¿…é ˆ</span>' : 
                            '<span class="badge optional-badge">ä»»æ„</span>';
                        
                        // æ¤œå‡ºè©³ç´°æƒ…å ±
                        let detailInfo = [];
                        if (field.hasLabel) detailInfo.push('ãƒ©ãƒ™ãƒ«æœ‰');
                        if (field.hasRequiredIndicator) detailInfo.push('å¿…é ˆè¡¨ç¤ºæœ‰');
                        if (field.hasOptionalIndicator) detailInfo.push('ä»»æ„è¡¨ç¤ºæœ‰');
                        if (field.hasInput) detailInfo.push('å…¥åŠ›æ¬„æœ‰');
                        
                        formHtml += `
                            <tr class="field-row ${statusClass}">
                                <td>${index + 1}</td>
                                <td><strong>${field.name}</strong></td>
                                <td><span class="field-type">${field.type}</span></td>
                                <td class="${statusClass}">
                                    ${statusBadge}
                                    <br><small>${statusText}</small>
                                </td>
                                <td><small>${field.detectionMethod}</small></td>
                                <td><small>${detailInfo.join(', ')}</small></td>
                            </tr>
                        `;
                    });
                    
                    formHtml += '</tbody></table>';
                    formHtml += '</div>';
                } else {
                    formHtml += '<div class="result-item">æœ‰åŠ¹ãªãƒ•ã‚©ãƒ¼ãƒ é …ç›®ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>';
                }
            }
            
            formAnalysisDiv.innerHTML = formHtml;
        }

        closeBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/close', {
                    method: 'POST'
                });
                const result = await response.json();
                addLog(result.message, 'success');
            } catch (error) {
                addLog(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });

        executeBtn.addEventListener('click', async () => {
            if (!uploadedData || !uploadedPdf) {
                addLog('JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™', 'error');
                return;
            }

            executeBtn.disabled = true;
            processingAborted = false; // æ–°ã—ã„å‡¦ç†é–‹å§‹æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
            clearResults();
            updateStatus('å®Ÿè¡Œä¸­...', 'info');
            addLog('å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');

            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/events');
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'log') {
                    addLog(data.message, data.level || 'info');
                } else if (data.type === 'result') {
                    displayResult(data.result);
                    addLog('åˆ¤å®šå®Œäº†', 'success');
                } else if (data.type === 'complete') {
                    updateStatus('å®Œäº†', 'success');
                    executeBtn.disabled = false;
                }
            };

            eventSource.onerror = () => {
                addLog('æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
                updateStatus('ã‚¨ãƒ©ãƒ¼', 'error');
                executeBtn.disabled = false;
                eventSource.close();
            };

            try {
                // FormDataã‚’ä½œæˆã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡
                const formData = new FormData();
                
                // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ä½œæˆ
                const jsonBlob = new Blob([JSON.stringify(uploadedData)], { type: 'application/json' });
                formData.append('jsonFile', jsonBlob, 'data.json');
                
                // PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
                formData.append('pdfFile', uploadedPdf);
                
                const response = await fetch('/execute', {
                    method: 'POST',
                    body: formData
                });

                const responseData = await response.json();
                
                if (!response.ok) {
                    showErrorPopup(
                        'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼',
                        'ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
                        responseData.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'
                    );
                    return;
                }

                // ğŸ” ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®è©³ç´°ãƒ‡ãƒãƒƒã‚°
                console.log(`ğŸ” ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹:`, responseData);
                console.log(`ğŸ” ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ :`, {
                    hasMessage: 'message' in responseData,
                    hasResult: 'result' in responseData,
                    messageValue: responseData.message,
                    resultKeys: responseData.result ? Object.keys(responseData.result) : 'undefined'
                });

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®æ­£è¦åŒ–
                const result = responseData.result || responseData;
                console.log(`ğŸ” æ­£è¦åŒ–å¾Œã®result:`, result);
                
                // ğŸš¨ æ–°ã—ã„è‡ªå‹•åœæ­¢æ©Ÿèƒ½ï¼šcriticalErrorãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
                if (result.criticalError) {
                    showErrorPopup(
                        result.stopReason || 'å‡¦ç†åœæ­¢',
                        result.errorMessage || 'é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚',
                        `ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${result.errorType || 'ä¸æ˜'}`
                    );
                    return;
                }

                // ğŸ” æœ€çµ‚çš„ãªresultæ§‹é€ ã®ãƒ‡ãƒãƒƒã‚°
                console.log(`ğŸ” æœ€çµ‚resultæ§‹é€ :`, {
                    inputJobName: result.inputJobName,
                    matchedJob: result.matchedJob,
                    matchType: result.matchType,
                    confidence: result.confidence,
                    extractionDetails: result.extractionDetails,
                    formAnalysis: result.formAnalysis
                });
                
                // æ®µéšçš„ãªã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (!validateProcessingResult(result, 'æ±‚äººåæŠ½å‡º')) return;
                if (!validateProcessingResult(result, 'æ±‚äººãƒãƒƒãƒãƒ³ã‚°')) return;
                if (!validateProcessingResult(result, 'PDFè§£æ')) return;
                if (!validateProcessingResult(result, 'ãƒ•ã‚©ãƒ¼ãƒ è§£æ')) return;
                if (!validateProcessingResult(result, 'ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°')) return;
                
                // ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ãŸå ´åˆã®ã¿å‡¦ç†ã‚’ç¶™ç¶š
                addLog('âœ… å…¨ã¦ã®æ¤œè¨¼ã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã€‚', 'success');
                
            } catch (error) {
                if (!processingAborted) {
                    showErrorPopup(
                        'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼',
                        'ã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
                        error.message
                    );
                }
            } finally {
                if (!processingAborted) {
                    executeBtn.disabled = false;
                }
            }
        });

        // PDFè§£æçµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayPdfAnalysis(pdfAnalysis) {
            const pdfAnalysisDiv = document.getElementById('pdfAnalysis');
            if (!pdfAnalysisDiv) return;

            let html = '<div class="analysis-section">';
            html += `<h4>ğŸ“„ PDFè§£æçµæœ</h4>`;
            html += `<div class="analysis-summary">`;
            html += `<p><strong>æŠ½å‡ºæ–¹æ³•:</strong> ${pdfAnalysis.method || 'pdf-parse-simple'}</p>`;
            html += `<p><strong>ä¿¡é ¼åº¦:</strong> ${pdfAnalysis.confidence || 0}%</p>`;
            html += `</div>`;

            html += `<h5>æŠ½å‡ºã•ã‚ŒãŸå€‹äººæƒ…å ±</h5>`;
            html += `<div class="pdf-data">`;
            
            if (pdfAnalysis.extractedName) html += `<p><strong>æ°å:</strong> ${pdfAnalysis.extractedName}</p>`;
            if (pdfAnalysis.furigana) html += `<p><strong>ãµã‚ŠãŒãª:</strong> ${pdfAnalysis.furigana}</p>`;
            if (pdfAnalysis.age) html += `<p><strong>å¹´é½¢:</strong> ${pdfAnalysis.age}æ­³</p>`;
            if (pdfAnalysis.phone) html += `<p><strong>é›»è©±ç•ªå·:</strong> ${pdfAnalysis.phone}</p>`;
            if (pdfAnalysis.email) html += `<p><strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> ${pdfAnalysis.email}</p>`;
            
            // æ¨è–¦æ™‚ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆå®Œå…¨è¡¨ç¤ºï¼‰
            if (pdfAnalysis.recommendationComment) {
                const comment = pdfAnalysis.recommendationComment;
                const displayComment = comment.length > 1000 ? 
                    comment.substring(0, 1000) + '...' : 
                    comment;
                html += `<p><strong>æ¨è–¦æ™‚ã‚³ãƒ¡ãƒ³ãƒˆ:</strong><br><span style="font-size: 0.9em; color: #666;">${displayComment.replace(/\n/g, '<br>')}</span></p>`;
            }
            
            // çµŒæ­´ï¼ˆè·å‹™è¦ç´„ï¼‰ï¼ˆå®Œå…¨è¡¨ç¤ºï¼‰
            if (pdfAnalysis.careerSummary) {
                const summary = pdfAnalysis.careerSummary;
                const displaySummary = summary.length > 1000 ? 
                    summary.substring(0, 1000) + '...' : 
                    summary;
                html += `<p><strong>çµŒæ­´ï¼ˆè·å‹™è¦ç´„ï¼‰:</strong><br><span style="font-size: 0.9em; color: #666;">${displaySummary.replace(/\n/g, '<br>')}</span></p>`;
            }
            
            // å®Ÿè£…æ¸ˆã¿é …ç›®ã®è¡¨ç¤º
            const implementedFields = ['æ°å', 'ãµã‚ŠãŒãª', 'å¹´é½¢', 'é›»è©±ç•ªå·', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'æ¨è–¦æ™‚ã‚³ãƒ¡ãƒ³ãƒˆ', 'çµŒæ­´'];
            html += `<p><em>å®Ÿè£…æ¸ˆã¿é …ç›®: ${implementedFields.join(', ')}</em></p>`;
            
            html += `</div>`;
            html += '</div>';

            pdfAnalysisDiv.innerHTML = html;
        }

        // å¿…é ˆé …ç›®ã¨ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayRequiredFieldsData(dataMapping) {
            const requiredFieldsDataDiv = document.getElementById('requiredFieldsData');
            if (!requiredFieldsDataDiv) return;

            let html = '<div class="mapping-section">';
            html += `<h4>ğŸ¯ å¿…é ˆé …ç›®ã¨ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°çµæœ</h4>`;
            html += `<div class="mapping-summary">`;
            html += `<p><strong>ãƒãƒƒãƒ”ãƒ³ã‚°æˆåŠŸ:</strong> ${dataMapping.mappedFields}å€‹</p>`;
            html += `<p><strong>ãƒãƒƒãƒ”ãƒ³ã‚°å¤±æ•—:</strong> ${dataMapping.unmappedFields.length}å€‹</p>`;
            html += `</div>`;

            if (dataMapping.mappings.length > 0) {
                html += `<h5>âœ… ãƒãƒƒãƒ”ãƒ³ã‚°æˆåŠŸé …ç›®</h5>`;
                html += `<div class="mapping-success">`;
                html += `<table class="mapping-table">`;
                html += `<thead><tr><th>é …ç›®å</th><th>å€¤</th><th>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</th><th>ä¿¡é ¼åº¦</th></tr></thead>`;
                html += `<tbody>`;
                
                dataMapping.mappings.forEach(mapping => {
                    const confidenceClass = mapping.confidence >= 90 ? 'high-confidence' : 
                                           mapping.confidence >= 70 ? 'medium-confidence' : 'low-confidence';
                    html += `<tr>`;
                    html += `<td>${mapping.fieldName}</td>`;
                    html += `<td>${mapping.value}</td>`;
                    html += `<td><span class="source-${mapping.source.toLowerCase()}">${mapping.source}</span></td>`;
                    html += `<td><span class="confidence ${confidenceClass}">${mapping.confidence}%</span></td>`;
                    html += `</tr>`;
                });
                
                html += `</tbody></table>`;
                html += `</div>`;
            }

            if (dataMapping.unmappedFields.length > 0) {
                html += `<h5>âŒ ãƒãƒƒãƒ”ãƒ³ã‚°å¤±æ•—é …ç›®</h5>`;
                html += `<div class="mapping-failed">`;
                html += `<table class="mapping-table">`;
                html += `<thead><tr><th>é …ç›®å</th><th>ç†ç”±</th></tr></thead>`;
                html += `<tbody>`;
                
                dataMapping.unmappedFields.forEach(field => {
                    html += `<tr>`;
                    html += `<td>${field.fieldName}</td>`;
                    html += `<td>${field.reason}</td>`;
                    html += `</tr>`;
                });
                
                html += `</tbody></table>`;
                html += `</div>`;
            }

            html += '</div>';
            requiredFieldsDataDiv.innerHTML = html;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•å…¥åŠ›æ©Ÿèƒ½ã¯å‰Šé™¤ï¼ˆHERPã‚µã‚¤ãƒˆã¸ã®ç›´æ¥å…¥åŠ›ã¯è¡Œã‚ãªã„ï¼‰

        // HERPç™»éŒ²æ©Ÿèƒ½ã®å¤‰æ•°
        let latestEnhancedData = null;
        let latestPdfFile = null;

        // HERPç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('registerToHerpBtn').addEventListener('click', async () => {
            if (!latestEnhancedData) {
                updateHerpRegistrationStatus('è§£æçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            if (!latestPdfFile) {
                updateHerpRegistrationStatus('å±¥æ­´æ›¸PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            const registerBtn = document.getElementById('registerToHerpBtn');
            registerBtn.disabled = true;
            registerBtn.textContent = 'ğŸ”„ è»¢è¨˜ä¸­...';

            try {
                updateHerpRegistrationStatus('HERPãƒ•ã‚©ãƒ¼ãƒ ã¸ã®è‡ªå‹•è»¢è¨˜ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'info');

                // FormDataã‚’ä½œæˆ
                const formData = new FormData();
                formData.append('enhancedData', JSON.stringify(latestEnhancedData));
                formData.append('pdfFile', latestPdfFile);

                const response = await fetch('/herp-register', {
                    method: 'POST',
                    body: formData
                });

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®Content-Typeã‚’ç¢ºèª
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    // JSONã§ãªã„å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å–å¾—
                    const textResponse = await response.text();
                    updateHerpRegistrationStatus(`âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ (HTML/ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã•ã‚Œã¾ã—ãŸ)`, 'error');
                    console.error('éJSONãƒ¬ã‚¹ãƒãƒ³ã‚¹:', textResponse);
                    return;
                }

                if (response.ok && result.success !== false && !result.criticalError) {
                    updateHerpRegistrationStatus(`âœ… HERPã¸ã®è»¢è¨˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼ (${result.filledFields}å€‹ã®é …ç›®ã‚’è»¢è¨˜)`, 'success');
                    herpRegistrationCompleted = true;
                    // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    document.getElementById('errorCheckBtn').style.display = 'inline-block';
                } else {
                    // ã‚µãƒ¼ãƒãƒ¼å´ã§å‡¦ç†ãŒå¤±æ•—ã—ã¦ã„ã‚‹å ´åˆ
                    const errorMsg = result.errorMessage || result.error || result.details || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
                    updateHerpRegistrationStatus(`âŒ è»¢è¨˜ã‚¨ãƒ©ãƒ¼: ${errorMsg}`, 'error');
                    herpRegistrationCompleted = false;
                    
                    // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ã‚°ã«è©³ç´°ã‚’è¡¨ç¤º
                    if (result.criticalError) {
                        addLog(`ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼: ${result.errorMessage || result.error}`, 'error');
                        if (result.stopReason) {
                            addLog(`ğŸ›‘ åœæ­¢ç†ç”±: ${result.stopReason}`, 'error');
                        }
                    }
                }
            } catch (error) {
                updateHerpRegistrationStatus(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'ğŸ“ HERPã«ç™»éŒ²ã™ã‚‹';
            }
        });

        function updateHerpRegistrationStatus(message, type) {
            const statusDiv = document.getElementById('herpRegistrationStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('errorCheckBtn').addEventListener('click', async () => {
            if (!herpRegistrationCompleted) {
                updateErrorCheckStatus('å…ˆã«HERPç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            if (!latestEnhancedData || !latestPdfFile) {
                updateErrorCheckStatus('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            const errorCheckBtn = document.getElementById('errorCheckBtn');
            errorCheckBtn.disabled = true;
            errorCheckBtn.textContent = 'ğŸ”„ ãƒã‚§ãƒƒã‚¯ä¸­...';

            try {
                updateErrorCheckStatus('è»¢è¨˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'info');

                const formData = new FormData();
                formData.append('enhancedData', JSON.stringify(latestEnhancedData));

                const response = await fetch('/error-check', {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const textResponse = await response.text();
                    updateErrorCheckStatus(`âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼`, 'error');
                    console.error('éJSONãƒ¬ã‚¹ãƒãƒ³ã‚¹:', textResponse);
                    return;
                }

                if (response.ok) {
                    if (result.hasErrors || result.criticalError) {
                        let errorMessage = `âŒ ${result.errors.length}ä»¶ã®ä¸ä¸€è‡´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:`;
                        result.errors.forEach((error, index) => {
                            errorMessage += `\n\n${index + 1}. ${error.field}`;
                            if (error.expected && error.actual) {
                                errorMessage += `\n  æœŸå¾…å€¤: "${error.expected}"\n  å®Ÿéš›: "${error.actual}"`;
                            }
                        });
                        
                        // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è¿½åŠ æƒ…å ±ã‚’è¡¨ç¤º
                        if (result.criticalError) {
                            errorMessage += `\n\nğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼: ${result.errorMessage || result.error}`;
                            if (result.stopReason) {
                                errorMessage += `\nğŸ›‘ åœæ­¢ç†ç”±: ${result.stopReason}`;
                            }
                        }
                        
                        updateErrorCheckStatus(errorMessage, 'error');
                        
                        // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ã‚°ã«ã‚‚è¨˜éŒ²
                        if (result.criticalError) {
                            addLog(`ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã§ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ${result.errorMessage || result.error}`, 'error');
                        }
                    } else {
                        updateErrorCheckStatus(`âœ… ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†: å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼å…¨ã¦ã®é …ç›®ãŒæ­£ã—ãè»¢è¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚`, 'success');
                    }
                } else {
                    const errorMsg = result.error || result.details || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
                    updateErrorCheckStatus(`âŒ ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${errorMsg}`, 'error');
                }
            } catch (error) {
                updateErrorCheckStatus(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                errorCheckBtn.disabled = false;
                errorCheckBtn.textContent = 'ğŸ” ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã™ã‚‹';
            }
        });

        function updateErrorCheckStatus(message, type) {
            const statusDiv = document.getElementById('errorCheckStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            statusDiv.style.whiteSpace = 'pre-wrap'; // æ”¹è¡Œã‚’è¡¨ç¤º
        }

        // è‡ªå‹•HERPè»¢è¨˜ï¼‹ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œé–¢æ•°
        async function executeAutoHerpRegistration() {
            if (processingAborted) {
                addLog('å‡¦ç†ãŒåœæ­¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è‡ªå‹•è»¢è¨˜ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™', 'warning');
                return;
            }

            if (!latestEnhancedData || !latestPdfFile) {
                showErrorPopup(
                    'è‡ªå‹•è»¢è¨˜ãƒ‡ãƒ¼ã‚¿ä¸è¶³',
                    'è‡ªå‹•è»¢è¨˜ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚',
                    'Enhanced JSONãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'
                );
                return;
            }

            addLog('è‡ªå‹•HERPè»¢è¨˜å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
            
            // 1. HERPè»¢è¨˜ã‚’å®Ÿè¡Œ
            const registerBtn = document.getElementById('registerToHerpBtn');
            registerBtn.disabled = true;
            registerBtn.textContent = 'ğŸ”„ è‡ªå‹•è»¢è¨˜ä¸­...';
            
            try {
                updateHerpRegistrationStatus('HERPãƒ•ã‚©ãƒ¼ãƒ ã¸ã®è‡ªå‹•è»¢è¨˜ã‚’å®Ÿè¡Œä¸­...', 'info');

                // FormDataã‚’ä½œæˆ
                const formData = new FormData();
                formData.append('enhancedData', JSON.stringify(latestEnhancedData));
                formData.append('pdfFile', latestPdfFile);

                const response = await fetch('/herp-register', {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const textResponse = await response.text();
                    updateHerpRegistrationStatus(`âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼`, 'error');
                    console.error('éJSONãƒ¬ã‚¹ãƒãƒ³ã‚¹:', textResponse);
                    registerBtn.disabled = false;
                    registerBtn.textContent = 'ğŸ“ HERPã«ç™»éŒ²ã™ã‚‹';
                    return;
                }

                if (response.ok && result.success !== false && !result.criticalError) {
                    // HERPè»¢è¨˜çµæœã®æ¤œè¨¼
                    if (!validateProcessingResult(result, 'HERPè»¢è¨˜')) return;
                    
                    updateHerpRegistrationStatus(`âœ… HERPã¸ã®è»¢è¨˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼ (${result.filledFields}å€‹ã®é …ç›®ã‚’è»¢è¨˜)`, 'success');
                    herpRegistrationCompleted = true;
                    document.getElementById('errorCheckBtn').style.display = 'inline-block';
                    
                    // 2. è‡ªå‹•ã§ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
                    addLog('è‡ªå‹•ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1ç§’å¾…æ©Ÿ
                    
                    await executeAutoErrorCheck();
                    
                } else {
                    // ã‚µãƒ¼ãƒãƒ¼å´ã§å‡¦ç†ãŒå¤±æ•—ã—ã¦ã„ã‚‹å ´åˆ
                    const errorMsg = result.errorMessage || result.error || result.details || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
                    const stopReason = result.stopReason || 'å‡¦ç†å¤±æ•—';
                    
                    showErrorPopup(
                        'HERPè»¢è¨˜å¤±æ•—',
                        'HERPãƒ•ã‚©ãƒ¼ãƒ ã¸ã®è»¢è¨˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                        `${errorMsg}\n\nåœæ­¢ç†ç”±: ${stopReason}`
                    );
                    
                    // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ã‚°ã«è©³ç´°ã‚’è¡¨ç¤º
                    if (result.criticalError) {
                        addLog(`ğŸš¨ HERPè»¢è¨˜ã§ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼: ${errorMsg}`, 'error');
                        addLog(`ğŸ›‘ åœæ­¢ç†ç”±: ${stopReason}`, 'error');
                    }
                    return;
                }
            } catch (error) {
                updateHerpRegistrationStatus(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'ğŸ“ HERPã«ç™»éŒ²ã™ã‚‹';
            }
        }

        // è‡ªå‹•ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œé–¢æ•°
        async function executeAutoErrorCheck() {
            if (processingAborted) {
                addLog('å‡¦ç†ãŒåœæ­¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™', 'warning');
                return;
            }

            const errorCheckBtn = document.getElementById('errorCheckBtn');
            errorCheckBtn.disabled = true;
            errorCheckBtn.textContent = 'ğŸ”„ è‡ªå‹•ãƒã‚§ãƒƒã‚¯ä¸­...';

            try {
                updateErrorCheckStatus('è»¢è¨˜ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­...', 'info');

                const formData = new FormData();
                formData.append('enhancedData', JSON.stringify(latestEnhancedData));

                const response = await fetch('/error-check', {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const textResponse = await response.text();
                    updateErrorCheckStatus(`âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼`, 'error');
                    console.error('éJSONãƒ¬ã‚¹ãƒãƒ³ã‚¹:', textResponse);
                    return;
                }

                if (response.ok) {
                    if (result.hasErrors || result.criticalError) {
                        // ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã§ä¸ä¸€è‡´æ¤œå‡ºæ™‚ã®è‡ªå‹•åœæ­¢
                        if (result.criticalError) {
                            showErrorPopup(
                                result.stopReason || 'ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´æ¤œå‡º',
                                result.errorMessage || 'ãƒ‡ãƒ¼ã‚¿ã®ä¸ä¸€è‡´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚',
                                `ä¸ä¸€è‡´é …ç›®æ•°: ${result.errors.length}ä»¶`
                            );
                            addLog(`ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã§ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ${result.errorMessage || result.error}`, 'error');
                            return;
                        }

                        let errorMessage = `âŒ ${result.errors.length}ä»¶ã®ä¸ä¸€è‡´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:`;
                        result.errors.forEach((error, index) => {
                            errorMessage += `\n\n${index + 1}. ${error.field}`;
                            if (error.expected && error.actual) {
                                errorMessage += `\n  æœŸå¾…å€¤: "${error.expected}"\n  å®Ÿéš›: "${error.actual}"`;
                            }
                        });
                        
                        // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è¿½åŠ æƒ…å ±ã‚’è¡¨ç¤º
                        if (result.criticalError) {
                            errorMessage += `\n\nğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼: ${result.errorMessage || result.error}`;
                            if (result.stopReason) {
                                errorMessage += `\nğŸ›‘ åœæ­¢ç†ç”±: ${result.stopReason}`;
                            }
                        }
                        
                        updateErrorCheckStatus(errorMessage, 'error');
                        addLog(`ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†: ${result.errors.length}ä»¶ã®ä¸ä¸€è‡´ã‚’æ¤œå‡º`, 'warning');
                        
                        // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã§ä¸æ•´åˆãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯å‡¦ç†ã‚’åœæ­¢
                        if (!validateProcessingResult(result, 'ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯')) return;
                    } else {
                        updateErrorCheckStatus(`âœ… ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†: å…¨ã¦ã®é …ç›®ãŒæ­£ã—ãè»¢è¨˜ã•ã‚Œã¦ã„ã¾ã™ï¼`, 'success');
                        addLog('ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†: å…¨é …ç›®æ­£å¸¸', 'success');
                    }
                } else {
                    const errorMsg = result.error || result.details || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
                    updateErrorCheckStatus(`âŒ ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${errorMsg}`, 'error');
                    
                    // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚å‡¦ç†ã‚’åœæ­¢
                    showErrorPopup(
                        'ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å¤±æ•—',
                        'ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å‡¦ç†ã§ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
                        errorMsg
                    );
                    return;
                }
            } catch (error) {
                updateErrorCheckStatus(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                
                // é€šä¿¡ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚å‡¦ç†ã‚’åœæ­¢
                if (!processingAborted) {
                    showErrorPopup(
                        'ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯é€šä¿¡ã‚¨ãƒ©ãƒ¼',
                        'ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å‡¦ç†ä¸­ã«é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
                        error.message
                    );
                }
            } finally {
                if (!processingAborted) {
                    errorCheckBtn.disabled = false;
                    errorCheckBtn.textContent = 'ğŸ” ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã™ã‚‹';
                }
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°
        function showErrorPopup(title, message, details = null) {
            processingAborted = true;
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’è¨­å®š
            document.querySelector('.error-popup-title').textContent = title;
            document.getElementById('errorPopupMessage').textContent = message;
            
            // è©³ç´°æƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤º
            const detailsDiv = document.getElementById('errorPopupDetails');
            if (details) {
                detailsDiv.textContent = details;
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
            document.getElementById('errorPopupOverlay').style.display = 'block';
            
            // ãƒ­ã‚°ã«ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²
            addLog(`âŒ å‡¦ç†åœæ­¢: ${title} - ${message}`, 'error');
            
            // å‡¦ç†åœæ­¢ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            markProcessingStopped();
        }

        function closeErrorPopup() {
            document.getElementById('errorPopupOverlay').style.display = 'none';
        }

        function markProcessingStopped() {
            // å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'å‡¦ç†åœæ­¢ä¸­ - ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„';
            executeBtn.classList.add('processing-stopped');
            
            // ä»–ã®ãƒœã‚¿ãƒ³ã‚‚ç„¡åŠ¹åŒ–
            const registerBtn = document.getElementById('registerToHerpBtn');
            const errorCheckBtn = document.getElementById('errorCheckBtn');
            if (registerBtn) registerBtn.disabled = true;
            if (errorCheckBtn) errorCheckBtn.disabled = true;
        }

        function validateProcessingResult(result, stepName) {
            if (processingAborted) {
                return false; // æ—¢ã«å‡¦ç†ãŒåœæ­¢ã—ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
            }

            // ğŸ” ãƒ‡ãƒãƒƒã‚°: æ±‚äººåã®å€¤ã‚’è©³ç´°ãƒ­ã‚°å‡ºåŠ›
            console.log(`ğŸ” [${stepName}] æ±‚äººåãƒ‡ãƒãƒƒã‚°:`, {
                inputJobName: result.inputJobName || 'undefined',
                extractedName: result.extractionDetails?.extractedName || 'undefined',
                matchedJob: result.matchedJob || 'undefined',
                matchType: result.matchType || 'undefined',
                confidence: result.confidence || 'undefined',
                stepName: stepName,
                timestamp: new Date().toISOString(),
                resultKeys: Object.keys(result)
            });
            
            // ğŸ” çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯
            if (!result) {
                console.error(`âŒ [${stepName}] resultãŒnullã¾ãŸã¯undefinedã§ã™`);
                showErrorPopup(
                    `${stepName}å‡¦ç†ã‚¨ãƒ©ãƒ¼`,
                    `${stepName}ã®å‡¦ç†çµæœãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`,
                    'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™ã€‚'
                );
                return false;
            }


            // ğŸš¨ æ–°ã—ã„è‡ªå‹•åœæ­¢æ©Ÿèƒ½ï¼šcriticalErrorãƒã‚§ãƒƒã‚¯
            if (result.criticalError) {
                showErrorPopup(
                    result.stopReason || 'å‡¦ç†åœæ­¢',
                    result.errorMessage || 'é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚',
                    `ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${result.errorType || 'ä¸æ˜'}`
                );
                return false;
            }

            // æ±‚äººæŠ½å‡ºã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (stepName === 'æ±‚äººåæŠ½å‡º' && result.extractionResult) {
                if (!result.extractionResult.success) {
                    showErrorPopup(
                        'æ±‚äººåæŠ½å‡ºå¤±æ•—',
                        'æ±‚äººåã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nå‡¦ç†ã‚’ç¶šè¡Œã§ãã¾ã›ã‚“ã€‚',
                        result.extractionResult.errors ? result.extractionResult.errors.join('\n') : 'åŸå› ä¸æ˜'
                    );
                    return false;
                }
                
                if (result.extractionResult.confidence < 80) {
                    showErrorPopup(
                        'æŠ½å‡ºä¿¡é ¼åº¦ä¸è¶³',
                        `æ±‚äººåã®æŠ½å‡ºä¿¡é ¼åº¦ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nä¿¡é ¼åº¦: ${result.extractionResult.confidence}% (æœ€ä½80%å¿…è¦)`,
                        'æ›–æ˜§ãªæ±‚äººåã®ãŸã‚ã€å®‰å…¨æ€§ã‚’è€ƒæ…®ã—ã¦å‡¦ç†ã‚’åœæ­¢ã—ã¾ã™ã€‚'
                    );
                    return false;
                }
            }

            // ãƒãƒƒãƒãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (stepName === 'æ±‚äººãƒãƒƒãƒãƒ³ã‚°') {
                // ğŸ” è©³ç´°ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                console.log(`ğŸ” æ±‚äººãƒãƒƒãƒãƒ³ã‚°ãƒã‚§ãƒƒã‚¯è©³ç´°:`, {
                    matchedJob: result.matchedJob,
                    matchType: result.matchType,
                    inputJobName: result.inputJobName,
                    confidence: result.confidence,
                    alternatives: result.alternatives,
                    errors: result.errors
                });
                
                // ãƒãƒƒãƒãƒ³ã‚°å¤±æ•—ã®å ´åˆï¼ˆmatchedJob ãŒ null ã¾ãŸã¯ matchType ãŒ 'none'ï¼‰
                if (!result.matchedJob || result.matchType === 'none' || result.matchedJob === null || result.matchedJob === undefined) {
                    console.error(`âŒ ãƒãƒƒãƒãƒ³ã‚°å¤±æ•—æ¤œå‡º:`, {
                        matchedJob: result.matchedJob,
                        matchType: result.matchType,
                        inputJobName: result.inputJobName,
                        confidence: result.confidence
                    });
                    showErrorPopup(
                        'æ±‚äººãƒãƒƒãƒãƒ³ã‚°å¤±æ•—',
                        `æ±‚äººã€Œ${result.inputJobName || 'ä¸æ˜'}ã€ã«å¯¾å¿œã™ã‚‹è·ç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nå‡¦ç†ã‚’åœæ­¢ã—ã¾ã™ã€‚`,
                        result.errors ? result.errors.join('\n') : 'HERPã«è©²å½“ã™ã‚‹æ±‚äººãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚'
                    );
                    return false;
                }
                
                // ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸã®ãƒ­ã‚°
                console.log(`âœ… ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸç¢ºèª:`, {
                    matchedJob: result.matchedJob,
                    matchType: result.matchType,
                    inputJobName: result.inputJobName,
                    confidence: result.confidence
                });

                // è¤‡æ•°ãƒãƒƒãƒãƒ³ã‚°ã®ãƒã‚§ãƒƒã‚¯
                if (result.alternatives && result.alternatives.length > 1) {
                    showErrorPopup(
                        'è¤‡æ•°ãƒãƒƒãƒãƒ³ã‚°æ¤œå‡º',
                        'è¤‡æ•°ã®æ±‚äººãŒãƒãƒƒãƒã—ã¾ã—ãŸã€‚\nå®‰å…¨æ€§ã®ãŸã‚å‡¦ç†ã‚’åœæ­¢ã—ã¾ã™ã€‚',
                        `ãƒãƒƒãƒã—ãŸæ±‚äºº: ${result.alternatives.join(', ')}`
                    );
                    return false;
                }

                // ä¿¡é ¼åº¦ãŒä½ã™ãã‚‹å ´åˆ
                if (result.confidence !== undefined && result.confidence < 85) {
                    showErrorPopup(
                        'ä¿¡é ¼åº¦ä¸è¶³',
                        `ãƒãƒƒãƒãƒ³ã‚°ä¿¡é ¼åº¦ãŒä¸ååˆ†ã§ã™ï¼ˆ${result.confidence}%ï¼‰ã€‚\nå®‰å…¨æ€§ã®ãŸã‚å‡¦ç†ã‚’åœæ­¢ã—ã¾ã™ã€‚`,
                        `æ±‚äºº: ${result.inputJobName} â†’ ${result.matchedJob}`
                    );
                    return false;
                }
            }

            // PDFè§£æã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (stepName === 'PDFè§£æ' && result.pdfResult) {
                if (!result.pdfResult.success) {
                    showErrorPopup(
                        'PDFè§£æå¤±æ•—',
                        'PDFãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                        result.pdfResult.error || 'PDFå½¢å¼ãŒå¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'
                    );
                    return false;
                }

                // å¿…é ˆãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                if (!result.pdfResult.extractedName) {
                    showErrorPopup(
                        'PDFå¿…é ˆãƒ‡ãƒ¼ã‚¿ä¸è¶³',
                        'PDFã‹ã‚‰æ°åã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nå±¥æ­´æ›¸å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                        'rirekishoå½¢å¼ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ã§ã™ã€‚'
                    );
                    return false;
                }
            }

            // ãƒ•ã‚©ãƒ¼ãƒ è§£æã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (stepName === 'ãƒ•ã‚©ãƒ¼ãƒ è§£æ' && result.formAnalysis) {
                if (!result.formAnalysis.success) {
                    showErrorPopup(
                        'ãƒ•ã‚©ãƒ¼ãƒ è§£æå¤±æ•—',
                        'HERPãƒ•ã‚©ãƒ¼ãƒ ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                        result.formAnalysis.error || 'ãƒ•ã‚©ãƒ¼ãƒ æ§‹é€ ãŒå¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'
                    );
                    return false;
                }

                if (!result.formAnalysis.fields || result.formAnalysis.fields.length === 0) {
                    showErrorPopup(
                        'ãƒ•ã‚©ãƒ¼ãƒ é …ç›®ä¸è¶³',
                        'HERPãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é …ç›®ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
                        'ãƒšãƒ¼ã‚¸ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'
                    );
                    return false;
                }
            }

            // ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (stepName === 'ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°' && result.mappingResult) {
                // å¿…é ˆé …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°å¤±æ•—ã®é‡è¦ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (result.mappingResult.criticalError || (!result.mappingResult.success && result.mappingResult.unmappedFields && result.mappingResult.unmappedFields.length > 0)) {
                    const unmappedFieldNames = result.mappingResult.unmappedFields ? 
                        result.mappingResult.unmappedFields.map(f => f.fieldName).join(', ') : 
                        'ä¸æ˜';
                    showErrorPopup(
                        'å¿…é ˆé …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°å¤±æ•—',
                        'å¿…é ˆé …ç›®ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã«å¤±æ•—ã—ãŸãŸã‚å‡¦ç†ã‚’åœæ­¢ã—ã¾ã™ã€‚',
                        result.mappingResult.error || `æœªãƒãƒƒãƒ”ãƒ³ã‚°é …ç›®: ${unmappedFieldNames}`
                    );
                    return false;
                }

                if (!result.mappingResult.success) {
                    showErrorPopup(
                        'ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°å¤±æ•—',
                        'å¿…é ˆé …ç›®ã®ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                        result.mappingResult.error || 'å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚'
                    );
                    return false;
                }

                // ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯
                if (result.mappingResult.lowConfidenceFields && result.mappingResult.lowConfidenceFields.length > 0) {
                    showErrorPopup(
                        'ãƒãƒƒãƒ”ãƒ³ã‚°ä¿¡é ¼åº¦ä¸è¶³',
                        'ä¸€éƒ¨ã®å¿…é ˆé …ç›®ã§ä¿¡é ¼åº¦ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚',
                        `ä½ä¿¡é ¼åº¦é …ç›®: ${result.mappingResult.lowConfidenceFields.join(', ')}`
                    );
                    return false;
                }
            }

            // HERPè»¢è¨˜ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (stepName === 'HERPè»¢è¨˜' && result.fillResult) {
                if (!result.fillResult.success) {
                    showErrorPopup(
                        'HERPè»¢è¨˜å¤±æ•—',
                        'HERPãƒ•ã‚©ãƒ¼ãƒ ã¸ã®è»¢è¨˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                        result.fillResult.error || 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒšãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
                    );
                    return false;
                }
            }

            // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯çµæœã®æ¤œè¨¼
            if (stepName === 'ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯' && result.hasErrors) {
                showErrorPopup(
                    'è»¢è¨˜å†…å®¹ä¸ä¸€è‡´æ¤œå‡º',
                    `${result.errors.length}ä»¶ã®è»¢è¨˜å†…å®¹ä¸ä¸€è‡´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\næ‰‹å‹•ç¢ºèªãŒå¿…è¦ã§ã™ã€‚`,
                    result.errors.map(err => `${err.field}: æœŸå¾…å€¤ã€Œ${err.expected}ã€â†’ å®Ÿéš›ã€Œ${err.actual}ã€`).join('\n')
                );
                return false;
            }

            return true; // ã‚¨ãƒ©ãƒ¼ãªã—
        }

        // åˆæœŸåŒ–
        addLog('æ±‚äººç…§åˆRPAãƒ„ãƒ¼ãƒ« (rirekishoç‰¹åŒ–ç‰ˆ) ãŒèµ·å‹•ã—ã¾ã—ãŸ');
        addLog('JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨rirekishoå½¢å¼PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
        addLog('å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€è‡ªå‹•ã§HERPè»¢è¨˜ã¨ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã¾ã§å®Ÿè¡Œã•ã‚Œã¾ã™', 'info');
        addLog('ç”°ä¸­å½¢å¼å±¥æ­´æ›¸ã®ã¿ã«ç‰¹åŒ–ã—ãŸå®‰å®šã‚·ã‚¹ãƒ†ãƒ ã§ã™');
        addLog('ğŸš¨ è‡ªå‹•åœæ­¢æ©Ÿèƒ½: ä»¥ä¸‹ã®å ´åˆã«å‡¦ç†ãŒè‡ªå‹•åœæ­¢ã—ã¾ã™', 'warning');
        addLog('  1. æ±‚äººãƒãƒƒãƒãƒ³ã‚°å¤±æ•—', 'warning');
        addLog('  2. å¿…é ˆé …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°å¤±æ•—ï¼ˆ1å€‹ä»¥ä¸Šï¼‰', 'warning');
        addLog('  3. ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã§ä¸ä¸€è‡´æ¤œå‡ºï¼ˆ1ä»¶ä»¥ä¸Šï¼‰', 'warning');
        addLog('âš ï¸ ã‚¨ãƒ©ãƒ¼æ™‚ã¯è‡ªå‹•ã§å‡¦ç†ãŒåœæ­¢ã—ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§è©³ç´°ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™', 'warning');
    </script>
</body>
</html>